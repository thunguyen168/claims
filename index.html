<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claims Resilience Testing Tool</title>
<style>
/* ===== Reset & Base ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
  background: #0f172a; color: #e2e8f0; min-height: 100vh;
}
a { color: #60a5fa; }

/* ===== Layout ===== */
.app { display: flex; min-height: 100vh; }
.sidebar {
  width: 280px; background: #1e293b; border-right: 1px solid #334155;
  padding: 20px; flex-shrink: 0; overflow-y: auto;
}
.main { flex: 1; padding: 24px; overflow-y: auto; }

/* ===== Navigation ===== */
.nav-title {
  font-size: 14px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 1px; color: #94a3b8; margin-bottom: 16px;
}
.nav-tabs { display: flex; gap: 4px; margin-bottom: 20px; }
.nav-tab {
  flex: 1; padding: 8px 4px; text-align: center; font-size: 12px; font-weight: 600;
  background: #334155; color: #94a3b8; border: none; border-radius: 6px; cursor: pointer;
  transition: all 0.2s;
}
.nav-tab.active { background: #3b82f6; color: #fff; }
.nav-tab:hover:not(.active) { background: #475569; }

/* ===== Form Controls ===== */
.form-group { margin-bottom: 16px; }
.form-group label {
  display: block; font-size: 12px; font-weight: 600;
  color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
}
select, input[type="number"], input[type="text"] {
  width: 100%; padding: 10px 12px; background: #0f172a; border: 1px solid #334155;
  border-radius: 8px; color: #e2e8f0; font-size: 14px; outline: none;
  transition: border-color 0.2s;
}
select:focus, input:focus { border-color: #3b82f6; }
.btn {
  padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px;
  font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%;
}
.btn-primary { background: #3b82f6; color: #fff; }
.btn-primary:hover { background: #2563eb; }
.btn-success { background: #22c55e; color: #fff; }
.btn-success:hover { background: #16a34a; }
.btn-danger { background: #ef4444; color: #fff; margin-top: 8px; }
.btn-danger:hover { background: #dc2626; }
.btn-secondary { background: #475569; color: #e2e8f0; margin-top: 8px; }
.btn-secondary:hover { background: #64748b; }

/* ===== Cards ===== */
.card {
  background: #1e293b; border: 1px solid #334155; border-radius: 12px;
  padding: 20px; margin-bottom: 20px;
}
.card-title {
  font-size: 16px; font-weight: 700; margin-bottom: 16px;
  padding-bottom: 12px; border-bottom: 1px solid #334155;
}

/* ===== Metrics Grid ===== */
.metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
.metric-card {
  background: #1e293b; border: 1px solid #334155; border-radius: 12px;
  padding: 16px; text-align: center;
}
.metric-value { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
.metric-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
.metric-green { color: #22c55e; }
.metric-yellow { color: #eab308; }
.metric-red { color: #ef4444; }
.metric-blue { color: #3b82f6; }

/* ===== Charts (Canvas-based) ===== */
.chart-container { position: relative; width: 100%; margin-bottom: 12px; }
canvas { width: 100%; display: block; }

/* ===== Capacity Table ===== */
.capacity-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.capacity-table th, .capacity-table td {
  padding: 10px 12px; text-align: left; border-bottom: 1px solid #334155;
}
.capacity-table th { color: #94a3b8; font-weight: 600; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
.status-ok { color: #22c55e; font-weight: 600; }
.status-warn { color: #eab308; font-weight: 600; }
.status-over { color: #ef4444; font-weight: 600; }

/* ===== Recommendations ===== */
.rec-list { list-style: none; }
.rec-list li { padding: 10px 12px; border-left: 3px solid #3b82f6; margin-bottom: 8px; background: #0f172a; border-radius: 0 8px 8px 0; font-size: 13px; }
.rec-list li.critical { border-left-color: #ef4444; }
.rec-list li.warning { border-left-color: #eab308; }
.rec-list li.info { border-left-color: #3b82f6; }

/* ===== Backend Admin ===== */
.admin-section { margin-bottom: 24px; }
.admin-section h3 { font-size: 14px; font-weight: 700; color: #94a3b8; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
.admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.admin-grid .form-group { margin-bottom: 8px; }
.site-card {
  background: #0f172a; border: 1px solid #334155; border-radius: 8px;
  padding: 16px; margin-bottom: 12px;
}
.site-card-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
}
.site-card-header h4 { font-size: 14px; font-weight: 600; }
.tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.tag-active { background: #22c55e22; color: #22c55e; }

/* ===== Header ===== */
.header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
}
.header h1 { font-size: 22px; font-weight: 800; }
.header-sub { font-size: 13px; color: #94a3b8; }

/* ===== Responsive ===== */
@media (max-width: 900px) {
  .app { flex-direction: column; }
  .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #334155; }
  .metrics { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 500px) {
  .metrics { grid-template-columns: 1fr; }
  .admin-grid { grid-template-columns: 1fr; }
}

/* ===== Legend ===== */
.chart-legend { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px; font-size: 12px; }
.legend-item { display: flex; align-items: center; gap: 6px; }
.legend-swatch { width: 12px; height: 12px; border-radius: 3px; }

/* ===== Toggle ===== */
.toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.toggle-label { font-size: 13px; }
.toggle {
  width: 40px; height: 22px; background: #475569; border-radius: 11px;
  position: relative; cursor: pointer; transition: background 0.2s;
}
.toggle.on { background: #3b82f6; }
.toggle::after {
  content: ''; position: absolute; width: 18px; height: 18px; background: #fff;
  border-radius: 50%; top: 2px; left: 2px; transition: transform 0.2s;
}
.toggle.on::after { transform: translateX(18px); }

/* Progress bar */
.progress-bar { height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin-top: 4px; }
.progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }

/* Range slider */
.range-group { margin-bottom: 16px; }
.range-group label { display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
.range-value { font-size: 13px; color: #3b82f6; font-weight: 700; float: right; }
input[type="range"] {
  -webkit-appearance: none; width: 100%; height: 6px; background: #334155;
  border-radius: 3px; outline: none; margin-top: 4px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 16px; height: 16px; background: #3b82f6;
  border-radius: 50%; cursor: pointer;
}
input[type="range"]::-moz-range-thumb {
  width: 16px; height: 16px; background: #3b82f6; border-radius: 50%;
  cursor: pointer; border: none;
}

/* Surge resources */
.surge-entry {
  display: flex; gap: 6px; align-items: center; margin-bottom: 6px;
  background: #0f172a; padding: 6px 8px; border-radius: 6px; font-size: 12px;
}
.surge-entry select, .surge-entry input {
  width: auto; padding: 4px 6px; font-size: 12px;
}
.surge-entry .btn { width: auto; padding: 4px 8px; font-size: 11px; }
.surge-list { max-height: 160px; overflow-y: auto; margin-bottom: 8px; }

/* Report button */
.btn-report { background: #8b5cf6; color: #fff; margin-top: 8px; }
.btn-report:hover { background: #7c3aed; }
</style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="nav-title">Claims Resilience Tool</div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchView('scenario')">Scenario</button>
      <button class="nav-tab" onclick="switchView('admin')">Admin</button>
    </div>

    <!-- Scenario Panel -->
    <div id="scenarioPanel">
      <div class="form-group">
        <label>Select Site</label>
        <select id="siteSelect" onchange="runScenario()"></select>
      </div>
      <div class="form-group">
        <label>Incident Type</label>
        <select id="incidentSelect" onchange="runScenario()">
          <option value="fire">Fire</option>
          <option value="explosion">Explosion</option>
          <option value="chemical">Chemical (Toxic Release)</option>
          <option value="nuclear">Nuclear (Radiological)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Claim Type</label>
        <select id="claimTypeSelect" onchange="runScenario()">
          <option value="both">Both (Injury + Property)</option>
          <option value="injury">Injury Claims (Bodily Injury)</option>
          <option value="property">Property Claims (PD/BI/Economic)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Time Horizon</label>
        <select id="timeHorizonSelect" onchange="runScenario()">
          <option value="short">Short Term (0-12 weeks)</option>
          <option value="medium">Medium Term (0-2 years)</option>
          <option value="long">Long Term (0-10+ years)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Severity Level</label>
        <select id="severitySelect" onchange="runScenario()">
          <option value="minor">Minor - Small local impact</option>
          <option value="moderate">Moderate - Neighbourhood impact</option>
          <option value="major">Major - Town/city impact</option>
          <option value="catastrophic">Catastrophic - Regional impact</option>
        </select>
      </div>
      <!-- Claim pattern information panel -->
      <div id="claimPatternNote" style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:10px;margin-bottom:12px;font-size:11px;color:#94a3b8">
        <strong style="color:#e2e8f0">Claim Pattern:</strong> <span id="patternDescription">Based on historical incident data</span>
      </div>
      <div id="historicalRefContainer" style="background:#1a1a2e;border:1px solid #3b82f6;border-radius:8px;padding:10px;margin-bottom:16px;font-size:10px;color:#60a5fa">
        <strong style="color:#93c5fd">Historical Reference:</strong> <span id="historicalReference"></span>
      </div>

      <div class="form-group">
        <label>Surge Resources</label>
        <div class="surge-list" id="surgeList"></div>
        <button class="btn btn-secondary" style="font-size:12px;padding:6px 10px" onclick="addSurgeEntry()">+ Add Surge Staff</button>
      </div>

      <div class="form-group">
        <label>Target Processing Time (weeks)</label>
        <input type="number" id="targetWeeksInput" value="12" min="1" max="52" step="1" onchange="runScenario()">
        <div style="font-size:10px;color:#64748b;margin-top:2px">All claims should be processed within this many weeks</div>
      </div>

      <div style="margin-top:20px">
        <button class="btn btn-primary" onclick="runScenario()">Run Scenario</button>
        <button class="btn btn-report" onclick="generateReport()">Generate PDF Report</button>
      </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" style="display:none">
      <div class="admin-section">
        <h3>Organisation Settings</h3>
        <div class="form-group">
          <label>Number of Claims Staff</label>
          <input type="number" id="adminStaff" value="8" onchange="saveAdmin()">
        </div>
        <div class="form-group">
          <label>Working Days per Week</label>
          <input type="number" id="adminWorkDays" value="5" onchange="saveAdmin()">
        </div>
        <div style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:12px;margin-top:8px">
          <div style="font-size:12px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Calculated Weekly Capacity</div>
          <div id="calculatedCapacity" style="font-size:22px;font-weight:800;color:#3b82f6">10</div>
          <div id="capacityFormula" style="font-size:11px;color:#64748b;margin-top:2px">8 staff × 5 days ÷ 4.0 avg days/claim</div>
        </div>
      </div>

      <div class="admin-section">
        <h3>Claim Complexity Mix</h3>
        <p style="font-size:11px;color:#64748b;margin-bottom:10px">Adjust the proportion of claims at each processing speed. Remaining % uses standard processing time.</p>
        <div class="range-group">
          <label>Auto-Processed (0 days) <span class="range-value" id="autoProcessedValue">10%</span></label>
          <input type="range" id="autoProcessedSlider" min="0" max="100" value="10" oninput="updateComplexitySlider()">
        </div>
        <div class="range-group">
          <label>Fast Track - 2 Days <span class="range-value" id="twoDayValue">20%</span></label>
          <input type="range" id="twoDaySlider" min="0" max="100" value="20" oninput="updateComplexitySlider()">
        </div>
        <div class="range-group" style="margin-bottom:8px">
          <label>Medium Track <span class="range-value" id="customDayValue">30%</span></label>
          <input type="range" id="customDaySlider" min="0" max="100" value="30" oninput="updateComplexitySlider()">
        </div>
        <div class="form-group" style="margin-bottom:4px">
          <label>Medium Track Days</label>
          <input type="number" id="customDaysInput" value="3" min="1" max="20" step="0.5" onchange="updateComplexitySlider()">
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label>Standard Track Days</label>
          <input type="number" id="standardDaysInput" value="4" min="1" max="30" step="0.5" onchange="updateComplexitySlider()">
        </div>
        <div id="complexityBreakdown" style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:10px;font-size:12px">
        </div>
      </div>

      <div class="admin-section">
        <h3>Incident Multipliers</h3>
        <div class="form-group">
          <label>Fire Multiplier</label>
          <input type="number" id="multFire" value="1.0" step="0.1" onchange="saveAdmin()">
        </div>
        <div class="form-group">
          <label>Explosion Multiplier</label>
          <input type="number" id="multExplosion" value="1.3" step="0.1" onchange="saveAdmin()">
        </div>
        <div class="form-group">
          <label>Chemical Multiplier</label>
          <input type="number" id="multChemical" value="1.5" step="0.1" onchange="saveAdmin()">
        </div>
        <div class="form-group">
          <label>Nuclear Multiplier</label>
          <input type="number" id="multNuclear" value="2.0" step="0.1" onchange="saveAdmin()">
        </div>
      </div>

      <div class="admin-section">
        <h3>Severity Claim Rates</h3>
        <p style="font-size:11px;color:#64748b;margin-bottom:8px">% of affected population filing claims</p>
        <div class="form-group">
          <label>Minor (%)</label>
          <input type="number" id="rateMinor" value="2" step="0.5" onchange="saveAdmin()">
        </div>
        <div class="form-group">
          <label>Moderate (%)</label>
          <input type="number" id="rateModerate" value="8" step="0.5" onchange="saveAdmin()">
        </div>
        <div class="form-group">
          <label>Major (%)</label>
          <input type="number" id="rateMajor" value="20" step="1" onchange="saveAdmin()">
        </div>
        <div class="form-group">
          <label>Catastrophic (%)</label>
          <input type="number" id="rateCatastrophic" value="45" step="1" onchange="saveAdmin()">
        </div>
      </div>

      <div class="admin-section">
        <h3>Sites Management</h3>
        <div id="sitesAdminList"></div>
        <button class="btn btn-success" onclick="addSitePrompt()" style="margin-top:12px">+ Add Site</button>
      </div>

      <div class="admin-section" style="margin-top:20px">
        <button class="btn btn-secondary" onclick="exportConfig()">Export Config</button>
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import Config</button>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importConfig(event)">
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="header">
      <div>
        <h1 id="mainTitle">Claims Resilience Testing</h1>
        <div class="header-sub" id="mainSub">Select a scenario to begin analysis</div>
      </div>
    </div>

    <div id="resultsArea" style="display:none">
      <!-- Key Metrics -->
      <div class="metrics" id="metricsGrid"></div>

      <!-- Claims Forecast Chart -->
      <div class="card">
        <div class="card-title" id="forecastChartTitle">Claims Forecast Over 12 Weeks</div>
        <div class="chart-container">
          <canvas id="forecastChart" height="300"></canvas>
        </div>
        <div class="chart-legend" id="forecastLegend"></div>
      </div>

      <!-- Capacity Chart -->
      <div class="card">
        <div class="card-title">Capacity Utilisation</div>
        <div class="chart-container">
          <canvas id="capacityChart" height="250"></canvas>
        </div>
        <div class="chart-legend" id="capacityLegend"></div>
      </div>

      <!-- Weekly Breakdown Table -->
      <div class="card">
        <div class="card-title">Weekly Breakdown</div>
        <div style="overflow-x:auto">
          <table class="capacity-table" id="weeklyTable">
            <thead><tr>
              <th>Week</th><th>New Claims</th><th>Cumulative</th><th>Processed</th><th>Backlog</th><th>Status</th>
            </tr></thead>
            <tbody id="weeklyBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Resource Requirements -->
      <div class="card">
        <div class="card-title">Resource Requirements</div>
        <div id="resourceContent"></div>
      </div>

      <!-- Claim Distribution Template -->
      <div class="card" id="distributionTemplateCard">
        <div class="card-title">Claim Distribution Pattern (Research-Based)</div>
        <div id="distributionTemplateContent"></div>
      </div>

      <!-- UK Legal Framework -->
      <div class="card" id="legalFrameworkCard" style="display:none">
        <div class="card-title">UK Legal Framework</div>
        <div id="legalFrameworkContent"></div>
      </div>

      <!-- Claim Categories Timeline -->
      <div class="card">
        <div class="card-title">Claim Categories & Timelines</div>
        <div id="claimCategoriesContent"></div>
      </div>

      <!-- Recommendations -->
      <div class="card">
        <div class="card-title">Recommendations</div>
        <ul class="rec-list" id="recList"></ul>
      </div>
    </div>

    <div id="welcomeArea">
      <div class="card" style="text-align:center;padding:60px 20px">
        <div style="font-size:48px;margin-bottom:16px">&#9881;</div>
        <h2 style="margin-bottom:12px">Claims Resilience Testing Tool</h2>
        <p style="color:#94a3b8;max-width:500px;margin:0 auto;line-height:1.6">
          Test your organisation's claim processing resilience across different incident scenarios.
          Select a site, incident type, and severity level from the sidebar to begin.
        </p>
        <p style="color:#64748b;margin-top:16px;font-size:13px">
          Use the Admin panel to configure sites, staff capacity, and processing parameters.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
// ===== DEFAULT CONFIGURATION =====
const DEFAULT_CONFIG = {
  organisation: {
    staffCount: 8,
    workDaysPerWeek: 5
  },
  claimComplexity: {
    autoProcessedPct: 10,    // % of claims auto-processed (0 days)
    twoDayPct: 20,           // % of claims processed in 2 days
    customDayPct: 30,        // % of claims processed in customDays
    customDays: 3,           // number of days for the custom tier
    standardDays: 4,         // number of days for the standard tier
    // remainder = 100 - auto - twoDay - custom = processed in standardDays
  },
  incidentMultipliers: {
    fire: 1.0,
    explosion: 1.3,
    chemical: 1.5,
    nuclear: 2.0
  },
  // Claim type split ratios (injury vs property) by incident type
  claimTypeSplits: {
    fire: { injury: 0.25, property: 0.75 },        // Fire: mostly property claims
    explosion: { injury: 0.30, property: 0.70 },   // Explosion: more injury than fire
    chemical: { injury: 0.60, property: 0.40 },    // Chemical: injury-dominant (Bhopal pattern)
    nuclear: { injury: 0.35, property: 0.65 }      // Nuclear: property-heavy (evacuation/decontamination)
  },
  severityRates: {
    minor: 0.02,
    moderate: 0.08,
    major: 0.20,
    catastrophic: 0.45
  },
  sites: [
    { id: 'hinkley', name: 'Hinkley Point', location: 'Somerset, England', population: 35000, staffOnSite: 4000, active: true },
    { id: 'sizewell', name: 'Sizewell', location: 'Suffolk, England', population: 25000, staffOnSite: 2500, active: true },
    { id: 'heysham', name: 'Heysham', location: 'Lancashire, England', population: 30000, staffOnSite: 3000, active: true }
  ]
};

// ===== CLAIM CATEGORIES & TIMING (Research-Based) =====
// Based on historical incident analysis: BP Texas City, Buncefield, Fukushima, Bhopal, West Texas
const CLAIM_CATEGORIES = {
  acutePhysicalInjury: {
    name: 'Acute Physical Injury',
    description: 'Burns, trauma, immediate effects',
    loggingTimeline: { min: 0, max: 7, unit: 'days' },
    settlementTimeline: { min: 6, max: 24, unit: 'months' },
    applicableIncidents: ['fire', 'explosion', 'chemical', 'nuclear']
  },
  propertyDamage: {
    name: 'Property Damage',
    description: 'Structural, contents, vehicles',
    loggingTimeline: { min: 0, max: 30, unit: 'days' },
    settlementTimeline: { min: 3, max: 18, unit: 'months' },
    applicableIncidents: ['fire', 'explosion', 'chemical', 'nuclear']
  },
  businessInterruption: {
    name: 'Business Interruption',
    description: 'Ongoing assessment required',
    loggingTimeline: { min: 1, max: 3, unit: 'months' },
    settlementTimeline: { min: 12, max: 36, unit: 'months' },
    applicableIncidents: ['fire', 'explosion', 'chemical', 'nuclear']
  },
  evacuationDisplacement: {
    name: 'Evacuation/Displacement',
    description: 'Temporary accommodation costs',
    loggingTimeline: { min: 0, max: 14, unit: 'days' },
    settlementTimeline: { min: 6, max: 18, unit: 'months' },
    applicableIncidents: ['chemical', 'nuclear', 'explosion']
  },
  environmentalRemediation: {
    name: 'Environmental Remediation',
    description: 'Long-term monitoring needed',
    loggingTimeline: { min: 3, max: 24, unit: 'months' },
    settlementTimeline: { min: 5, max: 40, unit: 'years' },
    applicableIncidents: ['chemical', 'nuclear']
  },
  latentHealthClaims: {
    name: 'Latent Health Claims',
    description: 'Cancer, respiratory disease (5-60 years post-incident)',
    loggingTimeline: { min: 5, max: 60, unit: 'years' },
    settlementTimeline: { min: 1, max: 3, unit: 'yearsAfterDiagnosis' },
    applicableIncidents: ['chemical', 'nuclear']
  },
  psychologicalInjury: {
    name: 'Psychological Injury',
    description: 'PTSD, anxiety',
    loggingTimeline: { min: 1, max: 36, unit: 'months' },
    settlementTimeline: { min: 12, max: 36, unit: 'months' },
    applicableIncidents: ['fire', 'explosion', 'chemical', 'nuclear']
  },
  secondaryConsequential: {
    name: 'Secondary/Consequential',
    description: 'Supply chain, third parties',
    loggingTimeline: { min: 3, max: 24, unit: 'months' },
    settlementTimeline: { min: 12, max: 48, unit: 'months' },
    applicableIncidents: ['fire', 'explosion', 'chemical', 'nuclear']
  }
};

// ===== UK LEGAL FRAMEWORK & LIMITATION PERIODS =====
const UK_LEGAL_FRAMEWORK = {
  standardLimitations: {
    personalInjury: { years: 3, note: 'From injury/knowledge, court discretion to extend' },
    propertyDamage: { years: 6, note: 'From date of damage' },
    employersLiability: { years: 3, note: 'Discovery rule applies' }
  },
  nuclearLimitations: {
    // UK Nuclear Installations Act 1965 (as amended 2022)
    pre2022: {
      operatorLiabilityCap: '£140 million',
      personalInjury: { years: 10 },
      propertyDamage: { years: 10 },
      environmentalReinstatement: false
    },
    post2022: {
      operatorLiabilityCap: '€700 million → €1.2 billion',
      personalInjury: { years: 30, note: 'Extended from 10 years' },
      propertyDamage: { years: 10 },
      environmentalReinstatement: true
    }
  },
  discoveryRule: {
    description: 'For latent injuries, clock starts when claimant has knowledge of: (1) The injury, (2) That it was significant, (3) That it was attributable to defendant, (4) Identity of defendant'
  }
};

// ===== RESERVE DEVELOPMENT FACTORS =====
// Based on historical claim development patterns
const RESERVE_DEVELOPMENT_FACTORS = {
  '0-12months': { min: 1.0, max: 1.2, note: 'Initial estimates often low' },
  '1-3years': { min: 1.2, max: 1.5, note: 'Litigation costs emerge' },
  '3-7years': { min: 1.3, max: 2.0, note: 'Regulatory actions peak' },
  '7-15years': { min: 1.5, max: 3.0, note: 'Cancer diagnoses begin' },
  '15-30years': { min: 2.0, max: 5.0, note: 'Mesothelioma-type claims' },
  '30plus': { min: null, max: null, note: 'Highly uncertain - nuclear/severe toxic only' }
};

// ===== HISTORICAL CLAIM VOLUME DATA =====
// Based on actual incident data from research
const HISTORICAL_CLAIM_VOLUMES = {
  // Chemical Plant Explosions
  chemicalExplosion: {
    reference: 'BP Texas City (2005), Buncefield UK (2005)',
    byVariety: {
      minor: { fatalities: 0, directInjuries: '1-10', propertyClaims: '10-50', latentHealth: '0-10' },
      moderate: { fatalities: '0-5', directInjuries: '10-100', propertyClaims: '50-500', latentHealth: '10-100' },
      major: { fatalities: '5-20', directInjuries: '100-500', propertyClaims: '500-5,000', latentHealth: '100-1,000' },
      catastrophic: { fatalities: '20+', directInjuries: '500+', propertyClaims: '5,000+', latentHealth: '1,000+' }
    },
    historicalExamples: {
      bpTexasCity2005: {
        fatalities: 15,
        injured: 180,
        totalClaims: 4000,
        openClaimsAt3_5Years: 1000,
        totalSettlements: '$2.1 billion',
        propertyDamage: '$200 million',
        firstTrial: '2.5 years post-incident',
        finalOSHASettlement: '7 years post-incident'
      },
      buncefield2005: {
        fatalities: 0,
        injured: 43,
        totalClaims: 2700,
        totalEstimate: '£300 million - £1 billion',
        classActionHearing: '10 months post-incident',
        biSettlementTime: '9+ months to finalise'
      }
    }
  },
  // Nuclear Incidents
  nuclear: {
    reference: 'Fukushima (2011), Three Mile Island (1979), Windscale (1957)',
    claimDevelopment: {
      immediate: { timeline: '0-6 months', claimTypes: 'Evacuation, acute injury', percentOfUltimate: '5-10%' },
      shortTerm: { timeline: '6 months - 3 years', claimTypes: 'Property, business interruption', percentOfUltimate: '20-30%' },
      mediumTerm: { timeline: '3-10 years', claimTypes: 'Ongoing health monitoring, environment', percentOfUltimate: '30-40%' },
      longTerm: { timeline: '10-30 years', claimTypes: 'Latent cancers, genetic effects', percentOfUltimate: '20-40%' }
    },
    historicalExamples: {
      fukushima2011: {
        evacuees: 164000,
        compensationPaidBy2021: '¥9.7 trillion (~$70 billion)',
        avgFamilyCompensation: '~$900,000',
        monthlyPsychologicalPayments: '~$1,000/month for 6+ years',
        decommissioningEstimate: '30-40 years'
      },
      threeMileIsland1979: {
        lawsuitsFiled: 2000,
        documentedCompensation: '$82 million',
        classActionSettlement: '$25 million (1981, 2 years post)',
        cleanupCompleted: '1993 (14 years)',
        totalCleanupCost: '$1 billion'
      }
    }
  },
  // Fertiliser/Ammonium Nitrate Explosions
  fertiliserExplosion: {
    reference: 'West, Texas (2013), Texas City Disaster (1947)',
    claimConcentrationByRadius: {
      '0-500m': { density: 'Very High (90%+)', primaryTypes: 'Total loss, fatality, severe injury' },
      '500m-1km': { density: 'High (60-80%)', primaryTypes: 'Significant structural, injury' },
      '1-3km': { density: 'Moderate (20-40%)', primaryTypes: 'Windows, minor structural' },
      '3-5km': { density: 'Low (5-10%)', primaryTypes: 'Glass breakage, hearing' }
    },
    historicalExamples: {
      westTexas2013: {
        fatalities: 15,
        injured: 260,
        buildingsDamaged: 150,
        totalInsuredLosses: '~$230 million',
        companyInsurance: '$1 million (severe underinsurance)',
        citySettlement: '$10.44 million (5 years post)',
        femaAwards: '$63.4 million to school district'
      }
    }
  },
  // Toxic Chemical Releases
  toxicRelease: {
    reference: 'Bhopal (1984), Seveso (1976)',
    longTailCharacteristics: [
      'Latency periods: 5-40+ years for cancers',
      'Causation disputes: Proving link between exposure and illness',
      'Generational effects: Children born after incident showing effects',
      'Environmental persistence: Ongoing groundwater/soil contamination'
    ],
    historicalExamples: {
      bhopal1984: {
        immediateDeaths: 3000,
        totalInjuryClaimsAwarded: 574304,
        totalClaimsRejected: 455213,
        totalCasesRegistered: 1029517,
        settlementAmount: '$470 million',
        settlementYear: 1989,
        avgDeathCompensation: '$2,200',
        avgInjuryCompensation: '$300-$500',
        ongoingEffects: '40+ years later, health effects still documented'
      }
    }
  },
  // Industrial Fires
  industrialFire: {
    reference: 'NFPA data, Allianz Global Claims Review',
    context: {
      percentOfDirectPropertyDamage: '69% of industrial sector losses',
      avgAnnualInsuredLosses: '$700+ million (manufacturing/industrial)',
      globalRank: '#1 cause of corporate insurance losses (21% by value)'
    },
    bySeverity: {
      contained: { propertyClaims: '1-10', injuryClaims: '0-5', biClaims: '0-5', typicalDuration: '3-12 months' },
      significant: { propertyClaims: '10-100', injuryClaims: '5-50', biClaims: '10-50', typicalDuration: '6-24 months' },
      majorMultiBuilding: { propertyClaims: '100-1,000', injuryClaims: '50-200', biClaims: '50-200', typicalDuration: '12-48 months' },
      catastrophic: { propertyClaims: '1,000+', injuryClaims: '200+', biClaims: '200+', typicalDuration: '24-60+ months' }
    }
  }
};

// ===== PROCESSING TIMELINE BY CLAIM TYPE =====
const PROCESSING_TIMELINES = {
  propertySimple: {
    name: 'Property (Simple)',
    initialAssessment: { min: 1, max: 4, unit: 'weeks' },
    settlementOffer: { min: 1, max: 3, unit: 'months' },
    finalResolution: { min: 3, max: 6, unit: 'months' }
  },
  propertyComplex: {
    name: 'Property (Complex)',
    initialAssessment: { min: 1, max: 3, unit: 'months' },
    settlementOffer: { min: 3, max: 9, unit: 'months' },
    finalResolution: { min: 6, max: 18, unit: 'months' }
  },
  businessInterruption: {
    name: 'Business Interruption',
    initialAssessment: { min: 3, max: 12, unit: 'months' },
    settlementOffer: { min: 6, max: 18, unit: 'months' },
    finalResolution: { min: 12, max: 36, unit: 'months' }
  },
  personalInjury: {
    name: 'Personal Injury',
    initialAssessment: { min: 1, max: 6, unit: 'months' },
    settlementOffer: { min: 6, max: 18, unit: 'months' },
    finalResolution: { min: 12, max: 36, unit: 'months' }
  }
};

// ===== CLAIM DISTRIBUTION TEMPLATES (Research-Based Percentages) =====
// Bimodal distribution: immediate spike + long tail for latent claims
const CLAIM_DISTRIBUTION_TEMPLATES = {
  explosionFire: {
    name: 'Explosion/Fire Incident',
    distribution: [
      { period: 'Week 1-4', percent: 70, types: 'Property damage, acute injury, evacuation' },
      { period: 'Month 2-12', percent: 20, types: 'Business interruption, delayed property, PTSD' },
      { period: 'Year 1-5', percent: 8, types: 'Complex injury, litigation, environmental' },
      { period: 'Year 5-30', percent: 2, types: 'Latent illness (if chemical exposure)' }
    ]
  },
  toxicRelease: {
    name: 'Toxic Release Incident',
    distribution: [
      { period: 'Week 1-4', percent: 25, types: 'Evacuation, acute poisoning, immediate property' },
      { period: 'Month 2-24', percent: 30, types: 'Respiratory illness, property decontamination' },
      { period: 'Year 2-10', percent: 25, types: 'Chronic illness develops, environmental cleanup' },
      { period: 'Year 10-40', percent: 20, types: 'Cancers, generational effects, ongoing environmental' }
    ]
  },
  nuclear: {
    name: 'Nuclear Incident',
    distribution: [
      { period: 'Week 1-4', percent: 10, types: 'Evacuation, acute radiation (if any)' },
      { period: 'Month 2-36', percent: 35, types: 'Property exclusion zones, business disruption' },
      { period: 'Year 3-15', percent: 30, types: 'Health monitoring, thyroid cancers, environment' },
      { period: 'Year 15-30', percent: 25, types: 'Late cancers, continued decommissioning' }
    ]
  }
};

// ===== KEY INSIGHTS FOR UK INSURERS =====
const UK_INSURER_INSIGHTS = [
  { insight: 'Immediate claims (0-12 months) represent 60-90% of property but only 40-60% of ultimate value for incidents with toxic exposure', category: 'timing' },
  { insight: 'Business interruption typically has longest processing time (12-36 months) and highest dispute rate', category: 'processing' },
  { insight: 'Latent health claims under UK law can be filed up to 30 years post-incident for nuclear; 3 years from discovery for other toxic exposure', category: 'legal' },
  { insight: 'Severity multipliers: Each order-of-magnitude increase in fatalities typically correlates with 5-10x increase in total claim count', category: 'volume' },
  { insight: 'Underinsurance is common: West, Texas had $1M coverage vs. $230M losses; Bhopal settlement vastly underestimated long-term health costs', category: 'risk' },
  { insight: 'Environmental claims post-2022 Nuclear Installations Act now explicitly covered - expect higher nuclear liability reserves', category: 'legal' },
  { insight: 'Processing bottlenecks occur at 3-6 months (adjuster capacity) and 18-36 months (litigation)', category: 'processing' }
];

// ===== TIME HORIZON CONFIGURATIONS =====
const TIME_HORIZONS = {
  short: { weeks: 12, label: '12 Weeks', unitLabel: 'Week' },
  medium: { weeks: 104, label: '2 Years', unitLabel: 'Week' },  // 2 years = 104 weeks
  long: { weeks: 520, label: '10 Years', unitLabel: 'Month' }   // 10 years = 520 weeks, display as months
};

// ===== INCIDENT CLAIM PATTERNS =====
// Based on research: different claim patterns by incident type and claim type
// Returns an array of relative weights for each time period
const CLAIM_PATTERNS = {
  // Fire patterns
  fire: {
    // Fire injury: early spike (burns/inhalation), moderate tail for disability/long-term care
    injury: {
      short: { peakWeek: 2, shape: 'spike', tailWeight: 0.15 },
      medium: { peakWeek: 3, shape: 'fast_decay', tailWeight: 0.10 },
      long: { peakMonth: 2, shape: 'fast_decay', tailWeight: 0.05 }
    },
    // Fire property: immediate spike + re-scope waves, rebuild delays
    property: {
      short: { peakWeek: 3, shape: 'spike_rescope', tailWeight: 0.25 },
      medium: { peakWeek: 4, shape: 'extended_plateau', tailWeight: 0.20 },
      long: { peakMonth: 3, shape: 'gradual_decay', tailWeight: 0.10 }
    }
  },
  // Explosion patterns
  explosion: {
    // Explosion injury: lower count but high severity, early reporting
    injury: {
      short: { peakWeek: 1, shape: 'sharp_spike', tailWeight: 0.10 },
      medium: { peakWeek: 2, shape: 'fast_decay', tailWeight: 0.08 },
      long: { peakMonth: 1, shape: 'fast_decay', tailWeight: 0.05 }
    },
    // Explosion property: instant sharp spike (wide blast radius), BI develops over time
    property: {
      short: { peakWeek: 2, shape: 'sharp_spike', tailWeight: 0.30 },
      medium: { peakWeek: 3, shape: 'spike_bi_tail', tailWeight: 0.25 },
      long: { peakMonth: 2, shape: 'gradual_decay', tailWeight: 0.15 }
    }
  },
  // Chemical (toxic release) patterns - Bhopal-style
  chemical: {
    // Chemical injury: very fast spike (hours-weeks), then LONG tail (complications, disability, litigation)
    injury: {
      short: { peakWeek: 2, shape: 'sharp_spike', tailWeight: 0.35 },
      medium: { peakWeek: 3, shape: 'spike_long_tail', tailWeight: 0.40 },
      long: { peakMonth: 2, shape: 'very_long_tail', tailWeight: 0.50 }  // Decades of claims (Bhopal)
    },
    // Chemical property: mid-fast spike, depends on contamination persistence
    property: {
      short: { peakWeek: 4, shape: 'moderate_spike', tailWeight: 0.25 },
      medium: { peakWeek: 6, shape: 'extended_plateau', tailWeight: 0.30 },
      long: { peakMonth: 4, shape: 'contamination_tail', tailWeight: 0.35 }
    }
  },
  // Nuclear (radiological) patterns - Fukushima/Chernobyl-style
  nuclear: {
    // Nuclear injury: small immediate spike, VERY long tail (latency, thyroid cancers, monitoring)
    injury: {
      short: { peakWeek: 3, shape: 'low_early', tailWeight: 0.40 },
      medium: { peakWeek: 8, shape: 'delayed_rise', tailWeight: 0.55 },
      long: { peakMonth: 36, shape: 'latency_driven', tailWeight: 0.70 }  // Peak years later
    },
    // Nuclear property: very large early-to-mid spike (evacuation, decontamination), extended plateau
    property: {
      short: { peakWeek: 3, shape: 'rapid_rise', tailWeight: 0.50 },
      medium: { peakWeek: 6, shape: 'evacuation_plateau', tailWeight: 0.60 },
      long: { peakMonth: 12, shape: 'stigma_tail', tailWeight: 0.45 }
    }
  }
};

// Load config from localStorage or use defaults
let config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
try {
  const saved = localStorage.getItem('claimsToolConfig');
  if (saved) {
    config = JSON.parse(saved);
    // Migrate old configs missing claimComplexity
    if (!config.claimComplexity) config.claimComplexity = JSON.parse(JSON.stringify(DEFAULT_CONFIG.claimComplexity));
  }
} catch(e) {}

function saveConfig() {
  try { localStorage.setItem('claimsToolConfig', JSON.stringify(config)); } catch(e) {}
}

// ===== CAPACITY CALCULATION =====
// Calculate weighted average days per claim based on complexity mix
function getWeightedDaysPerClaim() {
  const cc = config.claimComplexity || DEFAULT_CONFIG.claimComplexity;
  const autoPct = cc.autoProcessedPct / 100;
  const twoDayPct = cc.twoDayPct / 100;
  const customPct = cc.customDayPct / 100;
  const standardPct = Math.max(0, 1 - autoPct - twoDayPct - customPct);
  const customDays = cc.customDays || 3;
  const standardDays = cc.standardDays || 4;
  // weighted average: auto=0 days, twoDay=2 days, custom=customDays, standard=standardDays
  return (autoPct * 0) + (twoDayPct * 2) + (customPct * customDays) + (standardPct * standardDays);
}

// Calculate weekly capacity from staff, working days, and weighted processing time
function getWeeklyCapacity() {
  const weightedDays = getWeightedDaysPerClaim();
  if (weightedDays <= 0) return config.organisation.staffCount * config.organisation.workDaysPerWeek;
  return Math.round(config.organisation.staffCount * config.organisation.workDaysPerWeek / weightedDays);
}

// ===== VIEW SWITCHING =====
function switchView(view) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  if (view === 'scenario') {
    document.getElementById('scenarioPanel').style.display = '';
    document.getElementById('adminPanel').style.display = 'none';
    document.querySelectorAll('.nav-tab')[0].classList.add('active');
  } else {
    document.getElementById('scenarioPanel').style.display = 'none';
    document.getElementById('adminPanel').style.display = '';
    document.querySelectorAll('.nav-tab')[1].classList.add('active');
    loadAdmin();
  }
}

// ===== POPULATE SITE DROPDOWN =====
function populateSites() {
  const sel = document.getElementById('siteSelect');
  sel.innerHTML = '';
  config.sites.filter(s => s.active).forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.id; opt.textContent = s.name + ' - ' + s.location;
    sel.appendChild(opt);
  });
}

// ===== ADMIN PANEL =====
function loadAdmin() {
  document.getElementById('adminStaff').value = config.organisation.staffCount;
  document.getElementById('adminWorkDays').value = config.organisation.workDaysPerWeek;
  // Complexity sliders
  const cc = config.claimComplexity || DEFAULT_CONFIG.claimComplexity;
  document.getElementById('autoProcessedSlider').value = cc.autoProcessedPct;
  document.getElementById('twoDaySlider').value = cc.twoDayPct;
  document.getElementById('customDaySlider').value = cc.customDayPct;
  document.getElementById('customDaysInput').value = cc.customDays;
  document.getElementById('standardDaysInput').value = cc.standardDays || 4;
  updateComplexityDisplay();
  document.getElementById('multFire').value = config.incidentMultipliers.fire;
  document.getElementById('multExplosion').value = config.incidentMultipliers.explosion;
  document.getElementById('multChemical').value = config.incidentMultipliers.chemical || 1.5;
  document.getElementById('multNuclear').value = config.incidentMultipliers.nuclear || 2.0;
  document.getElementById('rateMinor').value = (config.severityRates.minor * 100);
  document.getElementById('rateModerate').value = (config.severityRates.moderate * 100);
  document.getElementById('rateMajor').value = (config.severityRates.major * 100);
  document.getElementById('rateCatastrophic').value = (config.severityRates.catastrophic * 100);
  renderSitesAdmin();
}

function saveAdmin() {
  config.organisation.staffCount = parseInt(document.getElementById('adminStaff').value) || 8;
  config.organisation.workDaysPerWeek = parseInt(document.getElementById('adminWorkDays').value) || 5;
  config.incidentMultipliers.fire = parseFloat(document.getElementById('multFire').value) || 1.0;
  config.incidentMultipliers.explosion = parseFloat(document.getElementById('multExplosion').value) || 1.3;
  config.incidentMultipliers.chemical = parseFloat(document.getElementById('multChemical').value) || 1.5;
  config.incidentMultipliers.nuclear = parseFloat(document.getElementById('multNuclear').value) || 2.0;
  config.severityRates.minor = (parseFloat(document.getElementById('rateMinor').value) || 2) / 100;
  config.severityRates.moderate = (parseFloat(document.getElementById('rateModerate').value) || 8) / 100;
  config.severityRates.major = (parseFloat(document.getElementById('rateMajor').value) || 20) / 100;
  config.severityRates.catastrophic = (parseFloat(document.getElementById('rateCatastrophic').value) || 45) / 100;
  updateComplexityDisplay();
  saveConfig();
  populateSites();
}

function updateComplexitySlider() {
  let autoPct = parseInt(document.getElementById('autoProcessedSlider').value) || 0;
  let twoDayPct = parseInt(document.getElementById('twoDaySlider').value) || 0;
  let customPct = parseInt(document.getElementById('customDaySlider').value) || 0;
  const customDays = parseFloat(document.getElementById('customDaysInput').value) || 3;
  const standardDays = parseFloat(document.getElementById('standardDaysInput').value) || 4;

  // Clamp so total doesn't exceed 100
  if (autoPct + twoDayPct + customPct > 100) {
    customPct = Math.max(0, 100 - autoPct - twoDayPct);
    document.getElementById('customDaySlider').value = customPct;
  }

  if (!config.claimComplexity) config.claimComplexity = {};
  config.claimComplexity.autoProcessedPct = autoPct;
  config.claimComplexity.twoDayPct = twoDayPct;
  config.claimComplexity.customDayPct = customPct;
  config.claimComplexity.customDays = customDays;
  config.claimComplexity.standardDays = standardDays;

  updateComplexityDisplay();
  saveConfig();
}

function updateComplexityDisplay() {
  const cc = config.claimComplexity || DEFAULT_CONFIG.claimComplexity;
  const standardPct = Math.max(0, 100 - cc.autoProcessedPct - cc.twoDayPct - cc.customDayPct);
  const weightedDays = getWeightedDaysPerClaim();
  const weeklyCapacity = getWeeklyCapacity();

  document.getElementById('autoProcessedValue').textContent = cc.autoProcessedPct + '%';
  document.getElementById('twoDayValue').textContent = cc.twoDayPct + '%';
  document.getElementById('customDayValue').textContent = cc.customDayPct + '%';

  document.getElementById('calculatedCapacity').textContent = weeklyCapacity;
  document.getElementById('capacityFormula').textContent =
    config.organisation.staffCount + ' staff × ' + config.organisation.workDaysPerWeek + ' days ÷ ' + weightedDays.toFixed(1) + ' avg days/claim';

  document.getElementById('complexityBreakdown').innerHTML = `
    <div style="display:flex;gap:4px;height:16px;border-radius:4px;overflow:hidden;margin-bottom:8px">
      ${cc.autoProcessedPct > 0 ? `<div style="width:${cc.autoProcessedPct}%;background:#22c55e" title="Auto"></div>` : ''}
      ${cc.twoDayPct > 0 ? `<div style="width:${cc.twoDayPct}%;background:#3b82f6" title="2-day"></div>` : ''}
      ${cc.customDayPct > 0 ? `<div style="width:${cc.customDayPct}%;background:#eab308" title="${cc.customDays}-day"></div>` : ''}
      ${standardPct > 0 ? `<div style="width:${standardPct}%;background:#ef4444" title="Standard"></div>` : ''}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;color:#94a3b8">
      <span><span style="color:#22c55e">●</span> Auto: ${cc.autoProcessedPct}%</span>
      <span><span style="color:#3b82f6">●</span> 2-day: ${cc.twoDayPct}%</span>
      <span><span style="color:#eab308">●</span> ${cc.customDays}-day: ${cc.customDayPct}%</span>
      <span><span style="color:#ef4444">●</span> Standard (${cc.standardDays || 4}d): ${standardPct}%</span>
    </div>
    <div style="margin-top:6px;color:#64748b;font-size:11px">Weighted avg: ${weightedDays.toFixed(1)} days/claim → <strong style="color:#3b82f6">${weeklyCapacity} claims/week</strong></div>
  `;
}

function renderSitesAdmin() {
  const container = document.getElementById('sitesAdminList');
  container.innerHTML = '';
  config.sites.forEach((site, idx) => {
    const div = document.createElement('div');
    div.className = 'site-card';
    div.innerHTML = `
      <div class="site-card-header">
        <h4>${site.name}</h4>
        <span class="tag ${site.active ? 'tag-active' : ''}">${site.active ? 'Active' : 'Inactive'}</span>
      </div>
      <div class="admin-grid">
        <div class="form-group">
          <label>Name</label>
          <input type="text" value="${site.name}" onchange="updateSite(${idx},'name',this.value)">
        </div>
        <div class="form-group">
          <label>Location</label>
          <input type="text" value="${site.location}" onchange="updateSite(${idx},'location',this.value)">
        </div>
        <div class="form-group">
          <label>Local Population</label>
          <input type="number" value="${site.population}" onchange="updateSite(${idx},'population',parseInt(this.value))">
        </div>
        <div class="form-group">
          <label>Staff on Site</label>
          <input type="number" value="${site.staffOnSite}" onchange="updateSite(${idx},'staffOnSite',parseInt(this.value))">
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-secondary" style="width:auto;padding:6px 12px;font-size:12px" onclick="toggleSiteActive(${idx})">${site.active ? 'Deactivate' : 'Activate'}</button>
        <button class="btn btn-danger" style="width:auto;padding:6px 12px;font-size:12px" onclick="removeSite(${idx})">Remove</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function updateSite(idx, field, value) {
  config.sites[idx][field] = value;
  if (field === 'name') {
    config.sites[idx].id = value.toLowerCase().replace(/[^a-z0-9]/g, '_');
  }
  saveConfig();
  populateSites();
  renderSitesAdmin();
}

function toggleSiteActive(idx) {
  config.sites[idx].active = !config.sites[idx].active;
  saveConfig();
  populateSites();
  renderSitesAdmin();
}

function removeSite(idx) {
  if (config.sites.length <= 1) { alert('You must have at least one site.'); return; }
  config.sites.splice(idx, 1);
  saveConfig();
  populateSites();
  renderSitesAdmin();
}

function addSitePrompt() {
  const name = prompt('Enter site name:');
  if (!name) return;
  const location = prompt('Enter location:') || '';
  const population = parseInt(prompt('Enter local population estimate:')) || 10000;
  const staff = parseInt(prompt('Enter staff on site:')) || 500;
  config.sites.push({
    id: name.toLowerCase().replace(/[^a-z0-9]/g, '_'),
    name: name,
    location: location,
    population: population,
    staffOnSite: staff,
    active: true
  });
  saveConfig();
  populateSites();
  renderSitesAdmin();
}

function exportConfig() {
  const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'claims-tool-config.json';
  a.click();
}

function importConfig(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      config = JSON.parse(e.target.result);
      saveConfig();
      populateSites();
      loadAdmin();
      alert('Configuration imported successfully.');
    } catch(err) {
      alert('Invalid config file.');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ===== CLAIMS DISTRIBUTION MODEL =====
// Advanced distribution model based on incident type, claim type, and time horizon

// Generate distribution based on shape type
function generateShapedDistribution(numPeriods, peakPeriod, shape, tailWeight) {
  const raw = [];

  for (let i = 1; i <= numPeriods; i++) {
    let val = 0;

    switch (shape) {
      case 'sharp_spike':
        // Very sharp spike, fast decay
        val = Math.exp(-0.8 * Math.pow((i - peakPeriod) / 1.2, 2)) + 0.01;
        break;

      case 'spike':
        // Standard spike with moderate decay
        val = Math.exp(-0.5 * Math.pow((i - peakPeriod) / 1.8, 2)) + 0.015;
        break;

      case 'moderate_spike':
        // Moderate spike, wider spread
        val = Math.exp(-0.4 * Math.pow((i - peakPeriod) / 2.5, 2)) + 0.02;
        break;

      case 'spike_rescope':
        // Initial spike with secondary bump (re-scoping for fire property)
        val = Math.exp(-0.5 * Math.pow((i - peakPeriod) / 1.5, 2)) +
              0.3 * Math.exp(-0.5 * Math.pow((i - peakPeriod - 4) / 2, 2)) + 0.02;
        break;

      case 'spike_bi_tail':
        // Spike with business interruption tail
        val = Math.exp(-0.6 * Math.pow((i - peakPeriod) / 1.5, 2));
        if (i > peakPeriod) {
          val += tailWeight * Math.exp(-0.1 * (i - peakPeriod));
        }
        val += 0.015;
        break;

      case 'fast_decay':
        // Fast initial spike, quick decay
        val = Math.exp(-0.7 * Math.pow((i - peakPeriod) / 1.3, 2)) + 0.01;
        break;

      case 'spike_long_tail':
        // Chemical injury: sharp spike with very long tail
        val = Math.exp(-0.6 * Math.pow((i - peakPeriod) / 1.5, 2));
        if (i > peakPeriod) {
          val += tailWeight * Math.pow(0.92, i - peakPeriod);  // Slow exponential decay
        }
        val += 0.02;
        break;

      case 'very_long_tail':
        // Chemical long-term: decades of claims
        val = Math.exp(-0.4 * Math.pow((i - peakPeriod) / 3, 2));
        if (i > peakPeriod) {
          val += tailWeight * Math.pow(0.97, i - peakPeriod);  // Very slow decay
        }
        val += 0.025;
        break;

      case 'low_early':
        // Nuclear injury short-term: low early, building concern
        val = 0.02 + 0.08 * Math.exp(-0.3 * Math.pow((i - peakPeriod) / 2, 2));
        if (i > peakPeriod) {
          val += tailWeight * Math.pow(0.85, i - peakPeriod);
        }
        break;

      case 'delayed_rise':
        // Nuclear injury medium-term: gradual rise to delayed peak
        val = 0.03 * (1 - Math.exp(-0.15 * i)) +
              0.15 * Math.exp(-0.3 * Math.pow((i - peakPeriod) / 4, 2));
        if (i > peakPeriod) {
          val += tailWeight * Math.pow(0.95, i - peakPeriod);
        }
        break;

      case 'latency_driven':
        // Nuclear injury long-term: very delayed peak (latency effects)
        val = 0.02 + 0.02 * Math.log1p(i / 10);  // Slow initial rise
        val += 0.12 * Math.exp(-0.2 * Math.pow((i - peakPeriod) / 15, 2));  // Broad peak
        if (i > peakPeriod) {
          val += tailWeight * Math.pow(0.98, i - peakPeriod);
        }
        break;

      case 'rapid_rise':
        // Nuclear property short-term: rapid rise for evacuation
        val = 0.05 + 0.25 * (1 - Math.exp(-0.5 * i));
        val *= Math.exp(-0.15 * Math.pow((i - peakPeriod) / 3, 2));
        val += tailWeight * 0.1;
        break;

      case 'evacuation_plateau':
        // Nuclear property medium-term: plateau from ongoing evacuation/displacement
        if (i < peakPeriod) {
          val = 0.1 * (1 - Math.exp(-0.3 * i));
        } else {
          val = 0.1 * Math.exp(-0.02 * (i - peakPeriod));  // Very slow decay (plateau)
        }
        val += 0.03;
        break;

      case 'extended_plateau':
        // Extended plateau shape
        val = Math.exp(-0.3 * Math.pow((i - peakPeriod) / 4, 2)) + 0.04;
        break;

      case 'gradual_decay':
        // Gradual decay from early peak
        val = Math.exp(-0.4 * Math.pow((i - peakPeriod) / 2.5, 2)) + 0.02;
        break;

      case 'contamination_tail':
        // Chemical property long-term: contamination discovery tail
        val = Math.exp(-0.35 * Math.pow((i - peakPeriod) / 5, 2));
        if (i > peakPeriod + 12) {
          val += 0.15 * Math.exp(-0.5 * Math.pow((i - peakPeriod - 36) / 10, 2));  // Secondary discovery
        }
        val += 0.02;
        break;

      case 'stigma_tail':
        // Nuclear property long-term: stigma and policy-driven resurgence
        val = Math.exp(-0.25 * Math.pow((i - peakPeriod) / 8, 2));
        // Add periodic resurgences (policy decisions, new disclosures)
        if (i > 24) val += 0.08 * Math.exp(-0.5 * Math.pow((i - 48) / 6, 2));
        if (i > 72) val += 0.06 * Math.exp(-0.5 * Math.pow((i - 84) / 6, 2));
        val += 0.025;
        break;

      default:
        // Fallback to standard bell curve
        val = Math.exp(-0.5 * Math.pow((i - peakPeriod) / 2, 2)) + 0.015;
    }

    raw.push(Math.max(0.005, val));
  }

  // Normalise to sum to 1
  const sum = raw.reduce((a, b) => a + b, 0);
  return raw.map(v => v / sum);
}

// Get distribution for a specific incident type, claim type, and time horizon
function getClaimDistribution(incident, claimType, timeHorizon) {
  const horizonConfig = TIME_HORIZONS[timeHorizon];
  const numPeriods = timeHorizon === 'long' ? 120 : horizonConfig.weeks;  // 120 months for long term

  // Get the pattern configuration
  const patterns = CLAIM_PATTERNS[incident] || CLAIM_PATTERNS.fire;
  const pattern = patterns[claimType] || patterns.injury;
  const horizonPattern = pattern[timeHorizon] || pattern.short;

  // Determine peak period
  let peakPeriod;
  if (timeHorizon === 'long') {
    peakPeriod = horizonPattern.peakMonth || 6;
  } else {
    peakPeriod = horizonPattern.peakWeek || 4;
  }

  return generateShapedDistribution(
    numPeriods,
    peakPeriod,
    horizonPattern.shape,
    horizonPattern.tailWeight
  );
}

// Legacy function for backward compatibility
function getWeeklyDistribution(peakWeek) {
  peakWeek = peakWeek || 4;
  const raw = [];
  const sigma = 1.5 + (peakWeek - 2) * 0.15;
  const mu = peakWeek;
  for (let w = 1; w <= 12; w++) {
    const val = Math.exp(-0.5 * Math.pow((w - mu) / sigma, 2)) + 0.015;
    raw.push(val);
  }
  const sum = raw.reduce((a, b) => a + b, 0);
  return raw.map(v => v / sum);
}

// ===== PATTERN DESCRIPTIONS =====
const PATTERN_DESCRIPTIONS = {
  fire: {
    injury: 'Early spike (0-7 days) from burns/smoke inhalation; 6-24 month settlement. Moderate tail for disability/PTSD cases (12-36 months)',
    property: 'Immediate spike (0-30 days), re-scope waves as hidden damage discovered. Simple: 3-6mo resolution; Complex: 6-18mo. BI exceeds PD by ~2.7x',
    template: 'explosionFire',
    historicalRef: 'NFPA/Allianz data: Fire/explosion = #1 cause of corporate losses (21% by value)'
  },
  explosion: {
    injury: 'Sharp immediate spike (0-7 days), lower count but high severity. Burns, TBI, amputations require specialist assessors',
    property: 'Instant sharp spike across blast radius (90%+ claims within 500m). BI develops over 12-36 months. Claim density drops rapidly with distance',
    template: 'explosionFire',
    historicalRef: 'BP Texas City: 15 fatalities, 4,000 claims, $2.1B settlements. Buncefield: 2,700 claims, £300M-1B'
  },
  chemical: {
    injury: 'Bimodal distribution: acute poisoning spike (25% in weeks 1-4), then very long tail extending decades. Bhopal: 1M+ claims over 40 years',
    property: 'Mid-fast spike for immediate damage, then resurgence (months 3-24) as soil/groundwater contamination discovered. Environmental: 5-40 years',
    template: 'toxicRelease',
    historicalRef: 'Bhopal (1984): 574,304 injury claims awarded, $470M settlement, avg compensation $300-500. Effects documented 40+ years later'
  },
  nuclear: {
    injury: 'Only 10% of ultimate claims in first month. Peak at 3-15 years (thyroid cancers). UK law allows claims up to 30 years post-incident (2022 Act)',
    property: 'Large early spike (evacuation 164,000+ at Fukushima), extended plateau from exclusion zones, stigma-driven resurgences decades later',
    template: 'nuclear',
    historicalRef: 'Fukushima: $70B+ compensation by 2021, avg family $900K. Three Mile Island: $82M documented, 14-year cleanup ($1B)'
  }
};

// Get applicable claim categories for an incident type
function getApplicableClaimCategories(incident) {
  return Object.entries(CLAIM_CATEGORIES)
    .filter(([key, cat]) => cat.applicableIncidents.includes(incident))
    .map(([key, cat]) => ({ key, ...cat }));
}

// Get historical examples for incident type
function getHistoricalExamples(incident) {
  switch(incident) {
    case 'fire':
      return HISTORICAL_CLAIM_VOLUMES.industrialFire;
    case 'explosion':
      return HISTORICAL_CLAIM_VOLUMES.chemicalExplosion;
    case 'chemical':
      return HISTORICAL_CLAIM_VOLUMES.toxicRelease;
    case 'nuclear':
      return HISTORICAL_CLAIM_VOLUMES.nuclear;
    default:
      return null;
  }
}

// Get reserve development factor for time horizon
function getReserveDevelopmentFactor(timeHorizon) {
  switch(timeHorizon) {
    case 'short': return RESERVE_DEVELOPMENT_FACTORS['0-12months'];
    case 'medium': return RESERVE_DEVELOPMENT_FACTORS['1-3years'];
    case 'long': return RESERVE_DEVELOPMENT_FACTORS['7-15years'];
    default: return RESERVE_DEVELOPMENT_FACTORS['0-12months'];
  }
}

// Get claim distribution template
function getClaimDistributionTemplate(incident) {
  const pattern = PATTERN_DESCRIPTIONS[incident];
  if (pattern && pattern.template) {
    return CLAIM_DISTRIBUTION_TEMPLATES[pattern.template];
  }
  return CLAIM_DISTRIBUTION_TEMPLATES.explosionFire;
}

function updatePatternDescription() {
  const incident = document.getElementById('incidentSelect').value;
  const claimType = document.getElementById('claimTypeSelect').value;
  const timeHorizon = document.getElementById('timeHorizonSelect').value;

  let description = '';
  const patterns = PATTERN_DESCRIPTIONS[incident] || PATTERN_DESCRIPTIONS.fire;

  if (claimType === 'both') {
    description = `Injury: ${patterns.injury}. Property: ${patterns.property}`;
  } else if (claimType === 'injury') {
    description = patterns.injury;
  } else {
    description = patterns.property;
  }

  // Add time horizon context
  if (timeHorizon === 'long') {
    description += ' (10+ year projection with latency effects)';
  } else if (timeHorizon === 'medium') {
    description += ' (2-year projection)';
  }

  const descEl = document.getElementById('patternDescription');
  if (descEl) descEl.textContent = description;

  // Update historical reference
  const histRefEl = document.getElementById('historicalReference');
  if (histRefEl && patterns.historicalRef) {
    histRefEl.textContent = patterns.historicalRef;
    histRefEl.parentElement.style.display = '';
  } else if (histRefEl) {
    histRefEl.parentElement.style.display = 'none';
  }
}

// ===== SURGE RESOURCE MANAGEMENT =====
let surgeEntries = []; // { startWeek, extraStaff }

function addSurgeEntry() {
  surgeEntries.push({ startWeek: 3, extraStaff: 4 });
  renderSurgeList();
  runScenario();
}

function removeSurgeEntry(idx) {
  surgeEntries.splice(idx, 1);
  renderSurgeList();
  runScenario();
}

function updateSurgeEntry(idx, field, value) {
  surgeEntries[idx][field] = parseInt(value) || 0;
  runScenario();
}

function renderSurgeList() {
  const container = document.getElementById('surgeList');
  container.innerHTML = '';
  surgeEntries.forEach((entry, idx) => {
    const div = document.createElement('div');
    div.className = 'surge-entry';
    div.innerHTML = `
      <span style="color:#94a3b8;white-space:nowrap">+</span>
      <input type="number" value="${entry.extraStaff}" min="1" max="100" style="width:50px"
        onchange="updateSurgeEntry(${idx},'extraStaff',this.value)">
      <span style="color:#94a3b8;white-space:nowrap">staff from W</span>
      <select onchange="updateSurgeEntry(${idx},'startWeek',this.value)">
        ${[1,2,3,4,5,6,7,8,9,10,11,12].map(w => `<option value="${w}" ${w === entry.startWeek ? 'selected' : ''}>W${w}</option>`).join('')}
      </select>
      <button class="btn btn-danger" onclick="removeSurgeEntry(${idx})">×</button>
    `;
    container.appendChild(div);
  });
}

let lastScenario = null;

// ===== SCENARIO CALCULATION =====
function runScenario() {
  const siteId = document.getElementById('siteSelect').value;
  const incident = document.getElementById('incidentSelect').value;
  const severity = document.getElementById('severitySelect').value;
  const claimType = document.getElementById('claimTypeSelect').value;
  const timeHorizon = document.getElementById('timeHorizonSelect').value;

  // Update pattern description
  updatePatternDescription();

  const site = config.sites.find(s => s.id === siteId);
  if (!site) return;

  const totalAffected = site.population + site.staffOnSite;
  const claimRate = config.severityRates[severity];
  const multiplier = config.incidentMultipliers[incident] || 1.0;
  const baseTotalClaims = Math.round(totalAffected * claimRate * multiplier);

  // Get claim type splits
  const splits = config.claimTypeSplits?.[incident] || DEFAULT_CONFIG.claimTypeSplits[incident] || { injury: 0.5, property: 0.5 };

  // Calculate claims by type
  let injuryClaims = 0, propertyClaims = 0, totalClaims = 0;
  if (claimType === 'both') {
    injuryClaims = Math.round(baseTotalClaims * splits.injury);
    propertyClaims = Math.round(baseTotalClaims * splits.property);
    totalClaims = injuryClaims + propertyClaims;
  } else if (claimType === 'injury') {
    injuryClaims = baseTotalClaims;
    totalClaims = injuryClaims;
  } else {
    propertyClaims = baseTotalClaims;
    totalClaims = propertyClaims;
  }

  // Get time horizon configuration
  const horizonConfig = TIME_HORIZONS[timeHorizon];
  const isLongTerm = timeHorizon === 'long';
  const numPeriods = isLongTerm ? 120 : horizonConfig.weeks;  // 120 months for long, weeks otherwise

  // Get distributions for each claim type
  const injuryDist = injuryClaims > 0 ? getClaimDistribution(incident, 'injury', timeHorizon) : [];
  const propertyDist = propertyClaims > 0 ? getClaimDistribution(incident, 'property', timeHorizon) : [];

  // Calculate claims per period
  const injuryPerPeriod = injuryDist.map(d => Math.round(injuryClaims * d));
  const propertyPerPeriod = propertyDist.map(d => Math.round(propertyClaims * d));

  // Combined claims per period
  const periodicClaims = [];
  for (let i = 0; i < numPeriods; i++) {
    periodicClaims.push({
      injury: injuryPerPeriod[i] || 0,
      property: propertyPerPeriod[i] || 0,
      total: (injuryPerPeriod[i] || 0) + (propertyPerPeriod[i] || 0)
    });
  }

  const baseWeeklyCapacity = getWeeklyCapacity();
  const weightedDaysPerClaim = getWeightedDaysPerClaim();
  const baseClaimsPerStaff = weightedDaysPerClaim > 0 ? config.organisation.workDaysPerWeek / weightedDaysPerClaim : config.organisation.workDaysPerWeek;

  // Adjust capacity for time horizon
  let periodCapacityMultiplier = 1;
  if (timeHorizon === 'long') {
    periodCapacityMultiplier = 4.33;  // Monthly capacity (weeks per month)
  }
  const basePeriodCapacity = Math.round(baseWeeklyCapacity * periodCapacityMultiplier);

  const targetWeeks = parseInt(document.getElementById('targetWeeksInput').value) || 12;
  const targetPeriods = isLongTerm ? Math.ceil(targetWeeks / 4.33) : targetWeeks;

  // Build period breakdown with backlog
  const periods = [];
  let cumulative = 0, cumulativeInjury = 0, cumulativeProperty = 0;
  let totalProcessed = 0;
  let backlog = 0;
  let peakPeriod = 0;
  let peakClaims = 0;
  let periodsToClear = 0;

  const maxSimPeriods = isLongTerm ? 120 : Math.max(numPeriods, 52);

  for (let i = 0; i < Math.min(numPeriods, maxSimPeriods); i++) {
    const periodNum = i + 1;

    // Calculate surge staff active this period (only for short/medium term)
    let surgeStaff = 0;
    if (!isLongTerm) {
      surgeEntries.forEach(entry => {
        if (periodNum >= entry.startWeek) surgeStaff += entry.extraStaff;
      });
    }
    const surgeCapacity = Math.round(surgeStaff * baseClaimsPerStaff * periodCapacityMultiplier);
    const effectiveCapacity = basePeriodCapacity + surgeCapacity;

    const newClaims = periodicClaims[i]?.total || 0;
    const newInjury = periodicClaims[i]?.injury || 0;
    const newProperty = periodicClaims[i]?.property || 0;

    cumulative += newClaims;
    cumulativeInjury += newInjury;
    cumulativeProperty += newProperty;

    const available = newClaims + backlog;
    const processed = Math.min(available, effectiveCapacity);
    totalProcessed += processed;
    backlog = available - processed;

    if (newClaims > peakClaims) { peakClaims = newClaims; peakPeriod = periodNum; }

    periods.push({
      period: periodNum,
      week: isLongTerm ? null : periodNum,
      month: isLongTerm ? periodNum : null,
      newClaims,
      newInjury,
      newProperty,
      cumulative,
      cumulativeInjury,
      cumulativeProperty,
      processed,
      backlog,
      effectiveCapacity,
      surgeStaff,
      utilisation: effectiveCapacity > 0 ? ((newClaims + (i > 0 ? periods[i-1].backlog : 0)) / effectiveCapacity) * 100 : 0
    });

  }

  // Find when all claims are actually cleared (backlog reaches 0 and stays 0)
  // Look backwards to find the last period with backlog > 0
  let lastBacklogPeriod = 0;
  for (let i = 0; i < periods.length; i++) {
    if (periods[i].backlog > 0) {
      lastBacklogPeriod = periods[i].period;
    }
  }

  if (lastBacklogPeriod > 0) {
    // Backlog existed at some point - clearance is when it finally went to 0
    // Check if it actually cleared within our simulation
    const nextPeriodIndex = lastBacklogPeriod; // periods array is 0-indexed
    if (nextPeriodIndex < periods.length && periods[nextPeriodIndex].backlog === 0) {
      periodsToClear = lastBacklogPeriod + 1;
    } else {
      // Backlog never fully cleared within simulation
      periodsToClear = -1;
    }
  } else if (cumulative > 0) {
    // No backlog ever built up - claims processed as they arrived
    // Time to clear = last period where claims arrived
    for (let i = periods.length - 1; i >= 0; i--) {
      if (periods[i].newClaims > 0) {
        periodsToClear = periods[i].period;
        break;
      }
    }
  }

  // Convert periods to weeks for display (short/medium term)
  const weeksToClear = isLongTerm ? (periodsToClear > 0 ? Math.round(periodsToClear * 4.33) : -1) : periodsToClear;
  // Compare in appropriate units: months for long-term, weeks for short/medium
  const canMeetTarget = isLongTerm
    ? (periodsToClear > 0 && periodsToClear <= targetPeriods)
    : (weeksToClear > 0 && weeksToClear <= targetWeeks);

  // Calculate resource needs
  const maxBacklog = Math.max(...periods.map(w => w.backlog));
  const overCapacityPeriods = periods.filter(w => w.newClaims > w.effectiveCapacity).length;
  const claimsPerStaffPerWeek = baseClaimsPerStaff;
  const staffNeededAtPeak = Math.ceil(peakClaims / (claimsPerStaffPerWeek * periodCapacityMultiplier));
  const additionalStaff = Math.max(0, staffNeededAtPeak - config.organisation.staffCount);

  // Store last scenario for report generation
  lastScenario = {
    site, incident, severity, claimType, timeHorizon, totalClaims, injuryClaims, propertyClaims,
    periods, peakPeriod, peakClaims, weeklyCapacity: baseWeeklyCapacity, periodCapacity: basePeriodCapacity,
    maxBacklog, overCapacityPeriods, additionalStaff, staffNeededAtPeak, claimsPerStaffPerWeek,
    surgeEntries: JSON.parse(JSON.stringify(surgeEntries)), weightedDaysPerClaim,
    targetWeeks, targetPeriods, weeksToClear, periodsToClear, canMeetTarget, isLongTerm, splits,
    claimComplexity: JSON.parse(JSON.stringify(config.claimComplexity || DEFAULT_CONFIG.claimComplexity))
  };

  // Display results
  showResults(lastScenario);
}

function showResults(scenario) {
  const s = scenario;

  document.getElementById('welcomeArea').style.display = 'none';
  document.getElementById('resultsArea').style.display = '';

  const incidentLabels = { fire: 'Fire', explosion: 'Explosion', chemical: 'Chemical (Toxic Release)', nuclear: 'Nuclear (Radiological)' };
  const severityLabels = { minor: 'Minor', moderate: 'Moderate', major: 'Major', catastrophic: 'Catastrophic' };
  const claimTypeLabels = { both: 'All Claims', injury: 'Injury Claims', property: 'Property Claims' };
  const horizonLabels = { short: 'Short Term (12 Weeks)', medium: 'Medium Term (2 Years)', long: 'Long Term (10+ Years)' };

  document.getElementById('mainTitle').textContent = s.site.name + ' - Scenario Analysis';
  document.getElementById('mainSub').textContent =
    incidentLabels[s.incident] + ' | ' + severityLabels[s.severity] + ' | ' + claimTypeLabels[s.claimType] + ' | ' + horizonLabels[s.timeHorizon];

  // Period label based on time horizon
  const periodLabel = s.isLongTerm ? 'Month' : 'Week';
  const peakPeriodLabel = s.isLongTerm ? `Month ${s.peakPeriod}` : `Week ${s.peakPeriod}`;

  // Metrics
  const timeToClearLabel = s.weeksToClear === -1
    ? (s.isLongTerm ? '10+ years' : '52+ weeks')
    : (s.isLongTerm ? s.periodsToClear + ' months' : s.weeksToClear + ' weeks');
  const targetLabel = s.isLongTerm ? s.targetPeriods + ' Months' : s.targetWeeks + ' Weeks';
  const showClaimBreakdown = s.claimType === 'both' && (s.injuryClaims > 0 || s.propertyClaims > 0);

  let metricsHTML = `
    <div class="metric-card">
      <div class="metric-value metric-blue">${s.totalClaims.toLocaleString()}</div>
      <div class="metric-label">Total Estimated Claims</div>
    </div>`;

  if (showClaimBreakdown) {
    metricsHTML += `
    <div class="metric-card">
      <div class="metric-value" style="color:#f97316">${s.injuryClaims.toLocaleString()}</div>
      <div class="metric-label">Injury Claims (${Math.round(s.splits.injury * 100)}%)</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" style="color:#8b5cf6">${s.propertyClaims.toLocaleString()}</div>
      <div class="metric-label">Property Claims (${Math.round(s.splits.property * 100)}%)</div>
    </div>`;
  }

  metricsHTML += `
    <div class="metric-card">
      <div class="metric-value metric-yellow">${peakPeriodLabel}</div>
      <div class="metric-label">Peak ${periodLabel} (${s.peakClaims} claims)</div>
    </div>
    <div class="metric-card">
      <div class="metric-value ${s.canMeetTarget ? 'metric-green' : 'metric-red'}">${s.canMeetTarget ? 'Yes' : 'No'}</div>
      <div class="metric-label">Cleared Within ${targetLabel}?</div>
    </div>
    <div class="metric-card">
      <div class="metric-value ${s.canMeetTarget ? 'metric-green' : 'metric-red'}">${timeToClearLabel}</div>
      <div class="metric-label">Time to Clear All Claims</div>
    </div>
    <div class="metric-card">
      <div class="metric-value ${s.additionalStaff === 0 ? 'metric-green' : 'metric-red'}">+${s.additionalStaff}</div>
      <div class="metric-label">Additional Staff Required</div>
    </div>
    <div class="metric-card">
      <div class="metric-value metric-yellow">${s.maxBacklog.toLocaleString()}</div>
      <div class="metric-label">Peak Backlog</div>
    </div>
    <div class="metric-card">
      <div class="metric-value ${s.overCapacityPeriods === 0 ? 'metric-green' : 'metric-red'}">${s.overCapacityPeriods}</div>
      <div class="metric-label">${periodLabel}s Over Capacity</div>
    </div>
  `;
  document.getElementById('metricsGrid').innerHTML = metricsHTML;

  // Determine display periods - sample for long term to keep table manageable
  let displayPeriods = s.periods;
  let samplingRate = 1;
  if (s.isLongTerm && s.periods.length > 24) {
    // For long term, show monthly data but sample every 3 months after first year
    samplingRate = 3;
    displayPeriods = s.periods.filter((p, i) => i < 12 || i % samplingRate === 0);
  } else if (s.timeHorizon === 'medium' && s.periods.length > 26) {
    // For medium term, show every 2 weeks after week 12
    displayPeriods = s.periods.filter((p, i) => i < 12 || i % 2 === 0);
  }

  // Limit display to reasonable size
  const maxDisplayPeriods = s.isLongTerm ? 40 : 52;
  if (displayPeriods.length > maxDisplayPeriods) {
    displayPeriods = displayPeriods.slice(0, maxDisplayPeriods);
  }

  // Period table
  const tbody = document.getElementById('weeklyBody');
  tbody.innerHTML = '';
  const hasSurge = displayPeriods.some(w => w.surgeStaff > 0);
  const hasClaimBreakdown = s.claimType === 'both';

  // Update table header
  const thead = document.querySelector('#weeklyTable thead tr');
  let headerHTML = `<th>${periodLabel}</th>`;
  if (hasClaimBreakdown) {
    headerHTML += `<th>Injury</th><th>Property</th>`;
  }
  headerHTML += `<th>New Claims</th><th>Cumulative</th><th>Capacity</th><th>Processed</th><th>Backlog</th>`;
  if (hasSurge) headerHTML += `<th>Surge Staff</th>`;
  headerHTML += `<th>Status</th>`;
  thead.innerHTML = headerHTML;

  displayPeriods.forEach(w => {
    const statusClass = w.backlog === 0 ? 'status-ok' : (w.backlog < w.effectiveCapacity ? 'status-warn' : 'status-over');
    const statusText = w.backlog === 0 ? 'On Track' : (w.backlog < w.effectiveCapacity ? 'Building Backlog' : 'Critical Backlog');
    const periodDisplay = s.isLongTerm ? `Month ${w.month}` : `Week ${w.week || w.period}`;

    const tr = document.createElement('tr');
    let rowHTML = `<td>${periodDisplay}</td>`;
    if (hasClaimBreakdown) {
      rowHTML += `<td style="color:#f97316">${w.newInjury.toLocaleString()}</td>`;
      rowHTML += `<td style="color:#8b5cf6">${w.newProperty.toLocaleString()}</td>`;
    }
    rowHTML += `
      <td>${w.newClaims.toLocaleString()}</td>
      <td>${w.cumulative.toLocaleString()}</td>
      <td>${w.effectiveCapacity.toLocaleString()}${w.surgeStaff > 0 ? ' <span style="color:#8b5cf6;font-size:11px">(+' + (w.effectiveCapacity - s.periodCapacity) + ')</span>' : ''}</td>
      <td>${w.processed.toLocaleString()}</td>
      <td>${w.backlog.toLocaleString()}</td>
      ${hasSurge ? '<td>' + (w.surgeStaff > 0 ? '+' + w.surgeStaff : '-') + '</td>' : ''}
      <td class="${statusClass}">${statusText}</td>
    `;
    tr.innerHTML = rowHTML;
    tbody.appendChild(tr);
  });

  // Resource requirements
  const capacityLabel = s.isLongTerm ? 'Claims/month' : 'Claims/week';
  const resHTML = `
    <div class="admin-grid" style="gap:16px">
      <div>
        <h4 style="margin-bottom:8px;font-size:14px">Current Capacity</h4>
        <p style="font-size:13px;color:#94a3b8">
          Staff: <strong style="color:#e2e8f0">${config.organisation.staffCount}</strong><br>
          ${capacityLabel}: <strong style="color:#e2e8f0">${s.periodCapacity}</strong><br>
          Claims/staff/week: <strong style="color:#e2e8f0">${s.claimsPerStaffPerWeek.toFixed(1)}</strong><br>
          Avg days per claim: <strong style="color:#e2e8f0">${s.weightedDaysPerClaim.toFixed(1)}</strong> (weighted)
        </p>
      </div>
      <div>
        <h4 style="margin-bottom:8px;font-size:14px">Required at Peak</h4>
        <p style="font-size:13px;color:#94a3b8">
          Staff needed: <strong style="color:#e2e8f0">${s.staffNeededAtPeak}</strong><br>
          Additional staff: <strong style="color:${s.additionalStaff > 0 ? '#ef4444' : '#22c55e'}">${s.additionalStaff > 0 ? '+' + s.additionalStaff : 'None'}</strong><br>
          Peak ${periodLabel.toLowerCase()} claims: <strong style="color:#e2e8f0">${s.peakClaims}</strong><br>
          ${periodLabel}s over capacity: <strong style="color:${s.overCapacityPeriods > 0 ? '#ef4444' : '#22c55e'}">${s.overCapacityPeriods}</strong>
        </p>
      </div>
      <div>
        <h4 style="margin-bottom:8px;font-size:14px">Target Assessment</h4>
        <p style="font-size:13px;color:#94a3b8">
          Target: <strong style="color:#e2e8f0">${targetLabel}</strong><br>
          Estimated clearance: <strong style="color:${s.canMeetTarget ? '#22c55e' : '#ef4444'}">${timeToClearLabel}</strong><br>
          Status: <strong style="color:${s.canMeetTarget ? '#22c55e' : '#ef4444'}">${s.canMeetTarget ? 'On Target' : 'Exceeds Target'}</strong>
        </p>
      </div>
    </div>
    <div style="margin-top:16px">
      <h4 style="margin-bottom:8px;font-size:14px">Capacity vs Demand at Peak</h4>
      <div class="progress-bar" style="height:20px;border-radius:6px">
        <div class="progress-fill" style="width:${Math.min(100, (s.periodCapacity / s.peakClaims) * 100)}%;background:${s.periodCapacity >= s.peakClaims ? '#22c55e' : '#ef4444'};border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">
          ${Math.round((s.periodCapacity / s.peakClaims) * 100)}%
        </div>
      </div>
      <p style="font-size:11px;color:#64748b;margin-top:4px">Current capacity covers ${Math.round((s.periodCapacity / s.peakClaims) * 100)}% of peak demand</p>
    </div>
  `;
  document.getElementById('resourceContent').innerHTML = resHTML;

  // Populate claim distribution template
  const distTemplate = getClaimDistributionTemplate(s.incident);
  if (distTemplate) {
    let distHTML = `<p style="font-size:13px;color:#94a3b8;margin-bottom:12px"><strong style="color:#e2e8f0">${distTemplate.name}</strong> - Bimodal distribution pattern based on historical incident data</p>`;
    distHTML += `<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px">`;
    distTemplate.distribution.forEach((phase, idx) => {
      const colors = ['#22c55e', '#3b82f6', '#eab308', '#ef4444'];
      const percentWidth = phase.percent;
      distHTML += `
        <div style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:12px">
          <div style="font-size:12px;font-weight:700;color:${colors[idx]};margin-bottom:4px">${phase.period}</div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <div style="flex:1;height:8px;background:#334155;border-radius:4px;overflow:hidden">
              <div style="width:${percentWidth}%;height:100%;background:${colors[idx]};border-radius:4px"></div>
            </div>
            <span style="font-size:14px;font-weight:700;color:${colors[idx]}">${phase.percent}%</span>
          </div>
          <div style="font-size:11px;color:#94a3b8">${phase.types}</div>
        </div>`;
    });
    distHTML += `</div>`;
    distHTML += `<p style="font-size:11px;color:#64748b;margin-top:12px;font-style:italic">Note: Claim development follows bimodal distribution - immediate spike of property/acute injury claims, followed by long tail of latent illness claims (30+ years for chemical/nuclear).</p>`;
    document.getElementById('distributionTemplateContent').innerHTML = distHTML;
  }

  // Populate UK Legal Framework (show for nuclear incidents)
  const legalCard = document.getElementById('legalFrameworkCard');
  if (s.incident === 'nuclear') {
    legalCard.style.display = '';
    const nuc = UK_LEGAL_FRAMEWORK.nuclearLimitations;
    let legalHTML = `
      <div style="margin-bottom:16px">
        <h4 style="font-size:13px;font-weight:700;color:#ef4444;margin-bottom:8px">UK Nuclear Installations Act 1965 (as amended 2022)</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div style="background:#0f172a;border:1px solid #334155;border-radius:8px;padding:12px">
            <div style="font-size:11px;color:#94a3b8;text-transform:uppercase;margin-bottom:6px">Pre-2022</div>
            <div style="font-size:12px;color:#e2e8f0">
              <div>Operator Liability: <strong>${nuc.pre2022.operatorLiabilityCap}</strong></div>
              <div>Personal Injury Limit: <strong>${nuc.pre2022.personalInjury.years} years</strong></div>
              <div>Property Damage Limit: <strong>${nuc.pre2022.propertyDamage.years} years</strong></div>
              <div>Environmental: <strong style="color:#ef4444">Not covered</strong></div>
            </div>
          </div>
          <div style="background:#0f172a;border:1px solid #22c55e;border-radius:8px;padding:12px">
            <div style="font-size:11px;color:#22c55e;text-transform:uppercase;margin-bottom:6px">Post-2022 (Current)</div>
            <div style="font-size:12px;color:#e2e8f0">
              <div>Operator Liability: <strong>${nuc.post2022.operatorLiabilityCap}</strong></div>
              <div>Personal Injury Limit: <strong style="color:#22c55e">${nuc.post2022.personalInjury.years} years</strong> <span style="font-size:10px;color:#94a3b8">(extended)</span></div>
              <div>Property Damage Limit: <strong>${nuc.post2022.propertyDamage.years} years</strong></div>
              <div>Environmental: <strong style="color:#22c55e">Now covered</strong></div>
            </div>
          </div>
        </div>
      </div>`;
    legalHTML += `
      <div style="background:#1a1a2e;border:1px solid #3b82f6;border-radius:8px;padding:12px;font-size:12px">
        <strong style="color:#60a5fa">Discovery Rule for Latent Injuries:</strong>
        <span style="color:#94a3b8">${UK_LEGAL_FRAMEWORK.discoveryRule.description}</span>
      </div>`;
    document.getElementById('legalFrameworkContent').innerHTML = legalHTML;
  } else {
    legalCard.style.display = 'none';
  }

  // Populate claim categories
  const categories = getApplicableClaimCategories(s.incident);
  let catHTML = `<div style="overflow-x:auto"><table class="capacity-table" style="font-size:12px">
    <thead><tr>
      <th>Claim Category</th>
      <th>Description</th>
      <th>Logging Timeline</th>
      <th>Settlement Timeline</th>
    </tr></thead><tbody>`;
  categories.forEach(cat => {
    const logUnit = cat.loggingTimeline.unit === 'yearsAfterDiagnosis' ? 'years (after diagnosis)' : cat.loggingTimeline.unit;
    const settleUnit = cat.settlementTimeline.unit === 'yearsAfterDiagnosis' ? 'years (after diagnosis)' : cat.settlementTimeline.unit;
    catHTML += `<tr>
      <td style="font-weight:600;color:#e2e8f0">${cat.name}</td>
      <td style="color:#94a3b8">${cat.description}</td>
      <td>${cat.loggingTimeline.min}-${cat.loggingTimeline.max} ${logUnit}</td>
      <td>${cat.settlementTimeline.min}-${cat.settlementTimeline.max} ${settleUnit}</td>
    </tr>`;
  });
  catHTML += `</tbody></table></div>`;

  // Add reserve development factors
  const reserveFactor = getReserveDevelopmentFactor(s.timeHorizon);
  if (reserveFactor) {
    catHTML += `
      <div style="margin-top:16px;background:#0f172a;border:1px solid #334155;border-radius:8px;padding:12px">
        <h4 style="font-size:12px;font-weight:700;color:#eab308;margin-bottom:8px">Reserve Development Factors (${s.timeHorizon} term)</h4>
        <div style="font-size:13px;color:#e2e8f0">
          Factor range: <strong>${reserveFactor.min}x - ${reserveFactor.max}x</strong> of initial estimates
          <span style="color:#94a3b8;font-size:11px;margin-left:8px">(${reserveFactor.note})</span>
        </div>
      </div>`;
  }
  document.getElementById('claimCategoriesContent').innerHTML = catHTML;

  // Recommendations - incident-specific
  const recs = buildRecommendations(s);
  const recList = document.getElementById('recList');
  recList.innerHTML = '';
  recs.forEach(r => {
    const li = document.createElement('li');
    li.className = r.level;
    li.textContent = r.text;
    recList.appendChild(li);
  });

  // Draw charts
  const chartTitle = s.isLongTerm ? `Claims Forecast Over ${displayPeriods.length} Months` :
                     `Claims Forecast Over ${displayPeriods.length} Weeks`;
  document.getElementById('forecastChartTitle').textContent = chartTitle;
  drawForecastChartNew(displayPeriods, s);
  drawCapacityChartNew(displayPeriods, s);
}

// Build recommendations based on incident type and claim patterns
function buildRecommendations(s) {
  const recs = [];
  const periodLabel = s.isLongTerm ? 'month' : 'week';

  // General capacity recommendations
  if (!s.canMeetTarget) {
    const clearLabel = s.weeksToClear === -1 ? (s.isLongTerm ? '10+ years' : '52+ weeks') : (s.isLongTerm ? s.periodsToClear + ' months' : s.weeksToClear + ' weeks');
    const targetLabel = s.isLongTerm ? s.targetPeriods + '-month' : s.targetWeeks + '-week';
    recs.push({ level: 'critical', text: `Claims will not be cleared within the ${targetLabel} target (estimated ${clearLabel}). Increase staff or add surge resources.` });
  }
  if (s.additionalStaff > 0) {
    recs.push({ level: 'critical', text: `Recruit or reassign ${s.additionalStaff} additional claims staff before peak ${periodLabel} (${s.isLongTerm ? 'Month' : 'Week'} ${s.peakPeriod}).` });
  }
  if (s.maxBacklog > s.periodCapacity * 2) {
    recs.push({ level: 'critical', text: `Peak backlog of ${s.maxBacklog.toLocaleString()} claims exceeds 2 ${periodLabel}s of capacity. Consider emergency outsourcing.` });
  }

  // Processing bottleneck warnings (research-based)
  if (s.timeHorizon === 'medium' || s.timeHorizon === 'long') {
    recs.push({ level: 'warning', text: 'Processing bottlenecks typically occur at 3-6 months (adjuster capacity) and 18-36 months (litigation phase). Plan surge resources accordingly.' });
  }

  // Reserve development factor warning
  const reserveFactor = getReserveDevelopmentFactor(s.timeHorizon);
  if (reserveFactor && (s.incident === 'chemical' || s.incident === 'nuclear')) {
    recs.push({ level: 'warning', text: `Reserve development factor for ${s.timeHorizon} term: ${reserveFactor.min}-${reserveFactor.max}x initial estimates. ${reserveFactor.note}.` });
  }

  // Incident-specific recommendations
  if (s.incident === 'chemical') {
    recs.push({ level: 'warning', text: 'BIMODAL DISTRIBUTION: Chemical releases show 25% of claims in weeks 1-4 (acute), then 45% emerge over years 2-40 (chronic effects, cancers). Bhopal example: 1M+ cases over 40 years.' });
    recs.push({ level: 'warning', text: 'Establish robust medical documentation protocols early - causation disputes are common. Discovery rule applies: 3-year limitation from when claimant gains knowledge of injury.' });
    if (s.claimType === 'both' || s.claimType === 'injury') {
      recs.push({ level: 'info', text: 'Set up medical monitoring programs for affected populations. Latent health claims (cancers, respiratory disease) may emerge 5-60 years post-incident.' });
      recs.push({ level: 'info', text: 'Historical reference: Bhopal awarded 574,304 injury claims with average compensation of $300-500. Generational effects documented.' });
    }
    if (s.claimType === 'both' || s.claimType === 'property') {
      recs.push({ level: 'info', text: 'Environmental remediation claims: 3-24 months to log, 5-40+ years to settle. Property claims may resurge from soil/groundwater contamination discovery.' });
    }
  }

  if (s.incident === 'nuclear') {
    recs.push({ level: 'critical', text: 'UK Nuclear Installations Act 2022: Personal injury limitation now 30 YEARS (extended from 10). Environmental reinstatement now explicitly covered. Operator liability €700M-1.2B.' });
    recs.push({ level: 'warning', text: 'Nuclear claim development: Only 5-10% of ultimate claims in first 6 months. 20-40% emerge at 10-30 years (latent cancers, genetic effects). Peak thyroid cancers at years 5-20.' });
    recs.push({ level: 'warning', text: 'Ensure specialist radiological assessors are available. Standard claims staff require additional training for radiation exposure claims.' });
    if (s.claimType === 'both' || s.claimType === 'property') {
      recs.push({ level: 'info', text: 'Property claims include evacuation (Fukushima: 164,000+ evacuees), exclusion zone losses, decontamination, and stigma-driven value impacts. Avg family compensation at Fukushima: ~$900,000.' });
    }
    if (s.claimType === 'both' || s.claimType === 'injury') {
      recs.push({ level: 'info', text: 'Psychological distress claims are significant: Fukushima paid ~$1,000/month for 6+ years. Establish clear eligibility criteria early for medical monitoring claims.' });
    }
    if (s.isLongTerm) {
      recs.push({ level: 'info', text: 'Stigma effects persist decades and cause claim resurgences following policy decisions or new disclosures. Three Mile Island cleanup took 14 years ($1B).' });
    }
  }

  if (s.incident === 'explosion') {
    recs.push({ level: 'warning', text: 'BLAST RADIUS CLAIM CONCENTRATION: 90%+ claims within 500m (total loss/severe), 60-80% at 500m-1km (significant structural), 20-40% at 1-3km (windows), 5-10% at 3-5km (glass/hearing).' });
    recs.push({ level: 'warning', text: 'Historical reference: BP Texas City - 15 fatalities, 4,000 claims, $2.1B settlements over 7 years. Buncefield - 2,700 claims, £300M-1B, BI settlements 9+ months.' });
    recs.push({ level: 'info', text: 'Business interruption claims become the pacing item (12-36 months processing). Require forensic accounting as downtime impacts develop.' });
    if (s.claimType === 'both' || s.claimType === 'injury') {
      recs.push({ level: 'info', text: 'Injury claims: lower count but high severity (burns, TBI, amputations). Acute physical injury: 0-7 days logging, 6-24 months settlement. Ensure specialist medical assessors.' });
    }
  }

  if (s.incident === 'fire') {
    recs.push({ level: 'warning', text: 'Fire/explosion = #1 cause of corporate insurance losses globally (21% by value). UK industrial sector: avg $700M+ annual insured losses, 69% of direct property damage.' });
    recs.push({ level: 'info', text: 'Expect property claim re-scope waves as hidden damage (soot, corrosion, smoke) discovered. Simple property: 3-6mo resolution. Complex: 6-18 months.' });
    if (s.claimType === 'both' || s.claimType === 'property') {
      recs.push({ level: 'info', text: 'Business interruption typically exceeds property damage by ~2.7x for industrial/petrochemical fires. BI assessment: 3-12 months, settlement: 12-36 months.' });
    }
  }

  // Underinsurance warning (research-based)
  if (s.severity === 'major' || s.severity === 'catastrophic') {
    recs.push({ level: 'warning', text: 'UNDERINSURANCE RISK: Historical examples - West, Texas: $1M coverage vs $230M losses. Review coverage limits against modelled exposure.' });
  }

  // Time horizon specific recommendations
  if (s.isLongTerm) {
    recs.push({ level: 'info', text: 'Long-term projections subject to significant uncertainty. Reserve development factors: 7-15 years = 1.5-3.0x; 15-30 years = 2.0-5.0x initial estimates.' });
    if (s.incident === 'chemical' || s.incident === 'nuclear') {
      recs.push({ level: 'info', text: 'Maintain claim tracking systems and IBNR reserves for late-emerging claims. Asbestos precedent: 20-60 year latency, $65B+ US insured losses.' });
    }
  }

  // Claim category-specific timelines
  const categories = getApplicableClaimCategories(s.incident);
  const psych = categories.find(c => c.key === 'psychologicalInjury');
  if (psych && (s.claimType === 'both' || s.claimType === 'injury')) {
    recs.push({ level: 'info', text: 'Psychological injury claims (PTSD, anxiety): 1-36 months to log, 12-36 months to settle. Common in all major incident types.' });
  }

  // General recommendations
  if (s.totalClaims > 1000) {
    recs.push({ level: 'warning', text: 'High claim volume expected. Implement digital/online claim submission. Processing bottleneck at 3-6 months due to adjuster capacity.' });
  }
  recs.push({ level: 'info', text: 'Establish dedicated claims hotline and information centre. Coordinate with local authorities and emergency services for efficient claim validation.' });
  recs.push({ level: 'info', text: 'Secondary/consequential claims (supply chain, third parties): 3-24 months to log, 12-48 months to settle. Plan for delayed reporting.' });

  return recs;
}

// ===== CHART DRAWING (Pure Canvas, no dependencies) =====

function drawForecastChartNew(periods, scenario) {
  const canvas = document.getElementById('forecastChart');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 300 * dpr;
  canvas.style.height = '300px';
  ctx.scale(dpr, dpr);
  const W = rect.width;
  const H = 300;

  ctx.clearRect(0, 0, W, H);

  const pad = { top: 20, right: 20, bottom: 40, left: 60 };
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;

  const s = scenario;
  const hasSurge = s.surgeEntries.length > 0 && !s.isLongTerm;
  const hasClaimBreakdown = s.claimType === 'both';
  const periodLabel = s.isLongTerm ? 'M' : 'W';

  const maxVal = Math.max(s.periodCapacity, ...periods.map(w => w.newClaims), ...periods.map(w => w.effectiveCapacity)) * 1.15;
  const xStep = chartW / Math.max(1, periods.length - 1);

  // Grid lines
  ctx.strokeStyle = '#334155';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (chartH / 4) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + chartW, y); ctx.stroke();
    ctx.fillStyle = '#64748b';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(Math.round(maxVal - (maxVal / 4) * i).toLocaleString(), pad.left - 8, y + 4);
  }

  // X labels (sample if too many)
  ctx.textAlign = 'center';
  ctx.fillStyle = '#64748b';
  const labelStep = periods.length > 24 ? Math.ceil(periods.length / 12) : 1;
  periods.forEach((w, i) => {
    if (i % labelStep === 0 || i === periods.length - 1) {
      const periodNum = s.isLongTerm ? w.month : (w.week || w.period);
      ctx.fillText(periodLabel + periodNum, pad.left + i * xStep, H - pad.bottom + 20);
    }
  });

  // Capacity line
  const capY = pad.top + chartH - (s.periodCapacity / maxVal) * chartH;
  ctx.strokeStyle = '#ef4444';
  ctx.lineWidth = 2;
  ctx.setLineDash([6, 4]);
  ctx.beginPath(); ctx.moveTo(pad.left, capY); ctx.lineTo(pad.left + chartW, capY); ctx.stroke();
  ctx.setLineDash([]);

  // If showing both claim types, draw stacked area
  if (hasClaimBreakdown) {
    // Property claims area (bottom)
    ctx.beginPath();
    ctx.moveTo(pad.left, pad.top + chartH);
    periods.forEach((w, i) => {
      const x = pad.left + i * xStep;
      const y = pad.top + chartH - (w.newProperty / maxVal) * chartH;
      ctx.lineTo(x, y);
    });
    ctx.lineTo(pad.left + (periods.length - 1) * xStep, pad.top + chartH);
    ctx.closePath();
    const gradProp = ctx.createLinearGradient(0, pad.top, 0, pad.top + chartH);
    gradProp.addColorStop(0, 'rgba(139,92,246,0.4)');
    gradProp.addColorStop(1, 'rgba(139,92,246,0.05)');
    ctx.fillStyle = gradProp;
    ctx.fill();

    // Injury claims area (on top of property)
    ctx.beginPath();
    ctx.moveTo(pad.left, pad.top + chartH - (periods[0].newProperty / maxVal) * chartH);
    periods.forEach((w, i) => {
      const x = pad.left + i * xStep;
      const yBase = pad.top + chartH - (w.newProperty / maxVal) * chartH;
      const yTop = yBase - (w.newInjury / maxVal) * chartH;
      ctx.lineTo(x, yTop);
    });
    for (let i = periods.length - 1; i >= 0; i--) {
      const x = pad.left + i * xStep;
      const y = pad.top + chartH - (periods[i].newProperty / maxVal) * chartH;
      ctx.lineTo(x, y);
    }
    ctx.closePath();
    const gradInj = ctx.createLinearGradient(0, pad.top, 0, pad.top + chartH);
    gradInj.addColorStop(0, 'rgba(249,115,22,0.4)');
    gradInj.addColorStop(1, 'rgba(249,115,22,0.05)');
    ctx.fillStyle = gradInj;
    ctx.fill();

    // Draw injury line
    ctx.strokeStyle = '#f97316';
    ctx.lineWidth = 2;
    ctx.beginPath();
    periods.forEach((w, i) => {
      const x = pad.left + i * xStep;
      const y = pad.top + chartH - ((w.newProperty + w.newInjury) / maxVal) * chartH;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // Draw property line
    ctx.strokeStyle = '#8b5cf6';
    ctx.lineWidth = 2;
    ctx.beginPath();
    periods.forEach((w, i) => {
      const x = pad.left + i * xStep;
      const y = pad.top + chartH - (w.newProperty / maxVal) * chartH;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();

  } else {
    // Single claim type - draw area fill
    ctx.beginPath();
    ctx.moveTo(pad.left, pad.top + chartH);
    periods.forEach((w, i) => {
      const x = pad.left + i * xStep;
      const y = pad.top + chartH - (w.newClaims / maxVal) * chartH;
      ctx.lineTo(x, y);
    });
    ctx.lineTo(pad.left + (periods.length - 1) * xStep, pad.top + chartH);
    ctx.closePath();
    const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + chartH);
    grad.addColorStop(0, 'rgba(59,130,246,0.3)');
    grad.addColorStop(1, 'rgba(59,130,246,0.02)');
    ctx.fillStyle = grad;
    ctx.fill();

    // Claims line
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 3;
    ctx.beginPath();
    periods.forEach((w, i) => {
      const x = pad.left + i * xStep;
      const y = pad.top + chartH - (w.newClaims / maxVal) * chartH;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // Data points (only if not too many)
    if (periods.length <= 24) {
      periods.forEach((w, i) => {
        const x = pad.left + i * xStep;
        const y = pad.top + chartH - (w.newClaims / maxVal) * chartH;
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fillStyle = '#3b82f6';
        ctx.fill();
        ctx.strokeStyle = '#1e293b';
        ctx.lineWidth = 2;
        ctx.stroke();
      });
    }
  }

  // Cumulative line (secondary Y-axis scale)
  const maxCum = periods[periods.length - 1].cumulative * 1.1;
  ctx.strokeStyle = '#22c55e';
  ctx.lineWidth = 2;
  ctx.setLineDash([4, 3]);
  ctx.beginPath();
  periods.forEach((w, i) => {
    const x = pad.left + i * xStep;
    const y = pad.top + chartH - (w.cumulative / maxCum) * chartH;
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();
  ctx.setLineDash([]);

  // Effective capacity line (if surge active)
  if (hasSurge) {
    ctx.strokeStyle = '#8b5cf6';
    ctx.lineWidth = 2;
    ctx.setLineDash([4, 3]);
    ctx.beginPath();
    periods.forEach((w, i) => {
      const x = pad.left + i * xStep;
      const y = pad.top + chartH - (w.effectiveCapacity / maxVal) * chartH;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // Legend
  let legendHTML = '';
  if (hasClaimBreakdown) {
    legendHTML = `
      <div class="legend-item"><div class="legend-swatch" style="background:#f97316"></div> Injury Claims</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#8b5cf6"></div> Property Claims</div>
    `;
  } else {
    legendHTML = `<div class="legend-item"><div class="legend-swatch" style="background:#3b82f6"></div> New Claims/${s.isLongTerm ? 'Month' : 'Week'}</div>`;
  }
  legendHTML += `
    <div class="legend-item"><div class="legend-swatch" style="background:#22c55e"></div> Cumulative Claims</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#ef4444"></div> Base Capacity (${s.periodCapacity})</div>
  `;
  if (hasSurge) {
    legendHTML += `<div class="legend-item"><div class="legend-swatch" style="background:#a855f7"></div> Effective Capacity (with surge)</div>`;
  }
  document.getElementById('forecastLegend').innerHTML = legendHTML;
}

function drawCapacityChartNew(periods, scenario) {
  const canvas = document.getElementById('capacityChart');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 250 * dpr;
  canvas.style.height = '250px';
  ctx.scale(dpr, dpr);
  const W = rect.width;
  const H = 250;

  ctx.clearRect(0, 0, W, H);

  const pad = { top: 20, right: 20, bottom: 40, left: 60 };
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;

  const s = scenario;
  const periodLabel = s.isLongTerm ? 'M' : 'W';

  // Sample if too many periods
  let displayPeriods = periods;
  if (periods.length > 24) {
    const step = Math.ceil(periods.length / 24);
    displayPeriods = periods.filter((_, i) => i % step === 0);
  }

  const barW = (chartW / displayPeriods.length) * 0.7;
  const gap = (chartW / displayPeriods.length) * 0.3;

  const maxUtil = Math.max(100, ...displayPeriods.map(w => w.utilisation)) * 1.15;

  // Grid
  ctx.strokeStyle = '#334155'; ctx.lineWidth = 1;
  [0, 25, 50, 75, 100].forEach(pct => {
    const y = pad.top + chartH - (pct / maxUtil) * chartH;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + chartW, y); ctx.stroke();
    ctx.fillStyle = '#64748b'; ctx.font = '11px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(pct + '%', pad.left - 8, y + 4);
  });

  // 100% line
  const y100 = pad.top + chartH - (100 / maxUtil) * chartH;
  ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2; ctx.setLineDash([6, 4]);
  ctx.beginPath(); ctx.moveTo(pad.left, y100); ctx.lineTo(pad.left + chartW, y100); ctx.stroke();
  ctx.setLineDash([]);

  // Bars
  displayPeriods.forEach((w, i) => {
    const x = pad.left + i * (chartW / displayPeriods.length) + gap / 2;
    const barH = (w.utilisation / maxUtil) * chartH;
    const y = pad.top + chartH - barH;

    let color;
    if (w.utilisation <= 70) color = '#22c55e';
    else if (w.utilisation <= 100) color = '#eab308';
    else color = '#ef4444';

    ctx.fillStyle = color;
    ctx.beginPath();
    const r = 3;
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + barW - r, y);
    ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
    ctx.lineTo(x + barW, pad.top + chartH);
    ctx.lineTo(x, pad.top + chartH);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.fill();

    // Label (only if not too many bars)
    if (displayPeriods.length <= 16) {
      ctx.fillStyle = '#e2e8f0'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
      ctx.fillText(Math.round(w.utilisation) + '%', x + barW / 2, y - 6);
    }

    // X label
    const periodNum = s.isLongTerm ? w.month : (w.week || w.period);
    ctx.fillStyle = '#64748b'; ctx.font = '11px sans-serif';
    ctx.fillText(periodLabel + periodNum, x + barW / 2, H - pad.bottom + 20);
  });

  document.getElementById('capacityLegend').innerHTML = `
    <div class="legend-item"><div class="legend-swatch" style="background:#22c55e"></div> Under 70%</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#eab308"></div> 70-100%</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#ef4444"></div> Over Capacity</div>
  `;
}

// Legacy chart functions for backward compatibility
function drawForecastChart(weeks, capacity, hasSurge) {
  const canvas = document.getElementById('forecastChart');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 300 * dpr;
  canvas.style.height = '300px';
  ctx.scale(dpr, dpr);
  const W = rect.width;
  const H = 300;

  ctx.clearRect(0, 0, W, H);

  const pad = { top: 20, right: 20, bottom: 40, left: 60 };
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;

  const maxVal = Math.max(capacity, ...weeks.map(w => w.newClaims), ...weeks.map(w => w.effectiveCapacity)) * 1.15;
  const xStep = chartW / 11;

  // Grid lines
  ctx.strokeStyle = '#334155';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (chartH / 4) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + chartW, y); ctx.stroke();
    ctx.fillStyle = '#64748b';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(Math.round(maxVal - (maxVal / 4) * i).toLocaleString(), pad.left - 8, y + 4);
  }

  // X labels
  ctx.textAlign = 'center';
  ctx.fillStyle = '#64748b';
  weeks.forEach((w, i) => {
    ctx.fillText('W' + w.week, pad.left + i * xStep, H - pad.bottom + 20);
  });

  // Capacity line
  const capY = pad.top + chartH - (capacity / maxVal) * chartH;
  ctx.strokeStyle = '#ef4444';
  ctx.lineWidth = 2;
  ctx.setLineDash([6, 4]);
  ctx.beginPath(); ctx.moveTo(pad.left, capY); ctx.lineTo(pad.left + chartW, capY); ctx.stroke();
  ctx.setLineDash([]);

  // Area fill under claims curve
  ctx.beginPath();
  ctx.moveTo(pad.left, pad.top + chartH);
  weeks.forEach((w, i) => {
    const x = pad.left + i * xStep;
    const y = pad.top + chartH - (w.newClaims / maxVal) * chartH;
    if (i === 0) ctx.lineTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.lineTo(pad.left + 11 * xStep, pad.top + chartH);
  ctx.closePath();
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + chartH);
  grad.addColorStop(0, 'rgba(59,130,246,0.3)');
  grad.addColorStop(1, 'rgba(59,130,246,0.02)');
  ctx.fillStyle = grad;
  ctx.fill();

  // Claims line with smooth curve
  ctx.strokeStyle = '#3b82f6';
  ctx.lineWidth = 3;
  ctx.beginPath();
  const points = weeks.map((w, i) => ({
    x: pad.left + i * xStep,
    y: pad.top + chartH - (w.newClaims / maxVal) * chartH
  }));

  // Draw smooth curve using bezier
  ctx.moveTo(points[0].x, points[0].y);
  for (let i = 1; i < points.length; i++) {
    const prev = points[i - 1];
    const curr = points[i];
    const cpx = (prev.x + curr.x) / 2;
    ctx.bezierCurveTo(cpx, prev.y, cpx, curr.y, curr.x, curr.y);
  }
  ctx.stroke();

  // Data points
  points.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
    ctx.fillStyle = '#3b82f6';
    ctx.fill();
    ctx.strokeStyle = '#1e293b';
    ctx.lineWidth = 2;
    ctx.stroke();
  });

  // Cumulative line
  const maxCum = weeks[weeks.length - 1].cumulative * 1.1;
  ctx.strokeStyle = '#22c55e';
  ctx.lineWidth = 2;
  ctx.setLineDash([4, 3]);
  ctx.beginPath();
  weeks.forEach((w, i) => {
    const x = pad.left + i * xStep;
    const y = pad.top + chartH - (w.cumulative / maxCum) * chartH;
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();
  ctx.setLineDash([]);

  // Effective capacity line (if surge active)
  if (hasSurge) {
    ctx.strokeStyle = '#8b5cf6';
    ctx.lineWidth = 2;
    ctx.setLineDash([4, 3]);
    ctx.beginPath();
    weeks.forEach((w, i) => {
      const x = pad.left + i * xStep;
      const y = pad.top + chartH - (w.effectiveCapacity / maxVal) * chartH;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // Legend
  document.getElementById('forecastLegend').innerHTML = `
    <div class="legend-item"><div class="legend-swatch" style="background:#3b82f6"></div> New Claims/Week</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#22c55e"></div> Cumulative Claims</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#ef4444"></div> Base Capacity (${capacity})</div>
    ${hasSurge ? '<div class="legend-item"><div class="legend-swatch" style="background:#8b5cf6"></div> Effective Capacity (with surge)</div>' : ''}
  `;
}

function drawCapacityChart(weeks, capacity) {
  const canvas = document.getElementById('capacityChart');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 250 * dpr;
  canvas.style.height = '250px';
  ctx.scale(dpr, dpr);
  const W = rect.width;
  const H = 250;

  ctx.clearRect(0, 0, W, H);

  const pad = { top: 20, right: 20, bottom: 40, left: 60 };
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;
  const barW = (chartW / 12) * 0.7;
  const gap = (chartW / 12) * 0.3;

  const maxUtil = Math.max(100, ...weeks.map(w => w.utilisation)) * 1.15;

  // Grid
  ctx.strokeStyle = '#334155'; ctx.lineWidth = 1;
  [0, 25, 50, 75, 100].forEach(pct => {
    const y = pad.top + chartH - (pct / maxUtil) * chartH;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + chartW, y); ctx.stroke();
    ctx.fillStyle = '#64748b'; ctx.font = '11px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(pct + '%', pad.left - 8, y + 4);
  });

  // 100% line
  const y100 = pad.top + chartH - (100 / maxUtil) * chartH;
  ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2; ctx.setLineDash([6, 4]);
  ctx.beginPath(); ctx.moveTo(pad.left, y100); ctx.lineTo(pad.left + chartW, y100); ctx.stroke();
  ctx.setLineDash([]);

  // Bars
  weeks.forEach((w, i) => {
    const x = pad.left + i * (chartW / 12) + gap / 2;
    const barH = (w.utilisation / maxUtil) * chartH;
    const y = pad.top + chartH - barH;

    let color;
    if (w.utilisation <= 70) color = '#22c55e';
    else if (w.utilisation <= 100) color = '#eab308';
    else color = '#ef4444';

    ctx.fillStyle = color;
    ctx.beginPath();
    // Rounded top corners
    const r = 3;
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + barW - r, y);
    ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
    ctx.lineTo(x + barW, pad.top + chartH);
    ctx.lineTo(x, pad.top + chartH);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.fill();

    // Label
    ctx.fillStyle = '#e2e8f0'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(Math.round(w.utilisation) + '%', x + barW / 2, y - 6);

    // X label
    ctx.fillStyle = '#64748b'; ctx.font = '11px sans-serif';
    ctx.fillText('W' + w.week, x + barW / 2, H - pad.bottom + 20);
  });

  document.getElementById('capacityLegend').innerHTML = `
    <div class="legend-item"><div class="legend-swatch" style="background:#22c55e"></div> Under 70%</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#eab308"></div> 70-100%</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#ef4444"></div> Over Capacity</div>
  `;
}

// ===== REPORT GENERATION =====
function generateReport() {
  if (!lastScenario) { alert('Run a scenario first.'); return; }
  const s = lastScenario;
  const incidentLabels = { fire: 'Fire', explosion: 'Explosion', chemical: 'Chemical (Toxic Release)', nuclear: 'Nuclear (Radiological)' };
  const severityLabels = { minor: 'Minor', moderate: 'Moderate', major: 'Major', catastrophic: 'Catastrophic' };
  const claimTypeLabels = { both: 'All Claims (Injury + Property)', injury: 'Injury Claims Only', property: 'Property Claims Only' };
  const horizonLabels = { short: 'Short Term (12 Weeks)', medium: 'Medium Term (2 Years)', long: 'Long Term (10+ Years)' };

  const now = new Date();
  const dateStr = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
  const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

  const periodLabel = s.isLongTerm ? 'Month' : 'Week';
  const capacityLabel = s.isLongTerm ? 'claims/month' : 'claims/week';

  const surgeRows = (s.surgeEntries.length > 0 && !s.isLongTerm)
    ? `<tr><td colspan="2" style="font-weight:700;padding-top:12px">Surge Resources Planned</td></tr>` +
      s.surgeEntries.map(e => `<tr><td>+${e.extraStaff} staff</td><td>From Week ${e.startWeek} onwards</td></tr>`).join('')
    : '';

  // Sample periods for display
  let displayPeriods = s.periods;
  if (s.isLongTerm && s.periods.length > 24) {
    displayPeriods = s.periods.filter((p, i) => i < 12 || i % 3 === 0);
  } else if (s.timeHorizon === 'medium' && s.periods.length > 26) {
    displayPeriods = s.periods.filter((p, i) => i < 12 || i % 2 === 0);
  }
  if (displayPeriods.length > 40) {
    displayPeriods = displayPeriods.slice(0, 40);
  }

  const hasClaimBreakdown = s.claimType === 'both';
  const periodRows = displayPeriods.map(w => {
    const statusClass = w.backlog === 0 ? '#22c55e' : (w.backlog < w.effectiveCapacity ? '#eab308' : '#ef4444');
    const statusText = w.backlog === 0 ? 'On Track' : (w.backlog < w.effectiveCapacity ? 'Building Backlog' : 'Critical Backlog');
    const periodNum = s.isLongTerm ? w.month : (w.week || w.period);
    let row = `<tr>
      <td>${periodLabel} ${periodNum}</td>`;
    if (hasClaimBreakdown) {
      row += `<td style="color:#d97706">${w.newInjury.toLocaleString()}</td>
              <td style="color:#7c3aed">${w.newProperty.toLocaleString()}</td>`;
    }
    row += `<td>${w.newClaims.toLocaleString()}</td>
      <td>${w.cumulative.toLocaleString()}</td>
      <td>${w.effectiveCapacity.toLocaleString()}${w.surgeStaff > 0 ? ' (+' + (w.effectiveCapacity - s.periodCapacity) + ')' : ''}</td>
      <td>${w.processed.toLocaleString()}</td>
      <td>${w.backlog.toLocaleString()}</td>
      <td style="color:${statusClass};font-weight:600">${statusText}</td>
    </tr>`;
    return row;
  }).join('');

  // Build recommendations
  const recs = buildRecommendations(s).map(r => {
    const level = r.level === 'critical' ? 'CRITICAL' : (r.level === 'warning' ? 'WARNING' : 'INFO');
    return { level, text: r.text };
  });

  const recsHtml = recs.map(r => {
    const color = r.level === 'CRITICAL' ? '#ef4444' : (r.level === 'WARNING' ? '#eab308' : '#3b82f6');
    return `<li style="padding:8px 12px;border-left:3px solid ${color};margin-bottom:6px;background:#f8fafc;border-radius:0 6px 6px 0">
      <strong style="color:${color}">[${r.level}]</strong> ${r.text}</li>`;
  }).join('');

  // Table headers
  let tableHeaders = `<th>${periodLabel}</th>`;
  if (hasClaimBreakdown) {
    tableHeaders += `<th>Injury</th><th>Property</th>`;
  }
  tableHeaders += `<th>New Claims</th><th>Cumulative</th><th>Capacity</th><th>Processed</th><th>Backlog</th><th>Status</th>`;

  // Claim breakdown metrics
  let claimBreakdownMetrics = '';
  if (hasClaimBreakdown) {
    claimBreakdownMetrics = `
  <div class="metric"><div class="metric-val" style="color:#d97706">${s.injuryClaims.toLocaleString()}</div><div class="metric-lbl">Injury Claims (${Math.round(s.splits.injury * 100)}%)</div></div>
  <div class="metric"><div class="metric-val" style="color:#7c3aed">${s.propertyClaims.toLocaleString()}</div><div class="metric-lbl">Property Claims (${Math.round(s.splits.property * 100)}%)</div></div>`;
  }

  const timeToClearLabel = s.weeksToClear === -1
    ? (s.isLongTerm ? '10+ years' : '52+ weeks')
    : (s.isLongTerm ? s.periodsToClear + ' months' : s.weeksToClear + ' weeks');
  const targetLabel = s.isLongTerm ? s.targetPeriods + ' Months' : s.targetWeeks + ' Weeks';

  const html = `<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><title>Claims Resilience Report - ${s.site.name}</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 1000px; margin: 0 auto; padding: 40px 20px; color: #1e293b; line-height: 1.6; }
  h1 { font-size: 24px; border-bottom: 2px solid #3b82f6; padding-bottom: 8px; }
  h2 { font-size: 18px; color: #3b82f6; margin-top: 32px; margin-bottom: 12px; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 20px; }
  th, td { padding: 6px 8px; text-align: left; border-bottom: 1px solid #e2e8f0; }
  th { background: #f1f5f9; font-weight: 600; color: #64748b; text-transform: uppercase; font-size: 10px; }
  .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
  .metric { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 14px; text-align: center; }
  .metric-val { font-size: 22px; font-weight: 800; }
  .metric-lbl { font-size: 10px; color: #64748b; text-transform: uppercase; }
  .green { color: #22c55e; } .red { color: #ef4444; } .blue { color: #3b82f6; } .yellow { color: #eab308; }
  ul { list-style: none; padding: 0; }
  .footer { margin-top: 40px; padding-top: 16px; border-top: 1px solid #e2e8f0; font-size: 11px; color: #94a3b8; }
  .pattern-note { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; margin: 16px 0; font-size: 13px; }
  @media print { body { padding: 20px; } }
</style></head><body>
<h1>Claims Resilience Report</h1>
<p style="color:#64748b;margin-top:-4px">Generated: ${dateStr} at ${timeStr}</p>

<h2>Scenario Parameters</h2>
<table>
  <tr><td style="font-weight:600;width:200px">Site</td><td>${s.site.name} - ${s.site.location}</td></tr>
  <tr><td style="font-weight:600">Incident Type</td><td>${incidentLabels[s.incident]}</td></tr>
  <tr><td style="font-weight:600">Claim Type</td><td>${claimTypeLabels[s.claimType]}</td></tr>
  <tr><td style="font-weight:600">Time Horizon</td><td>${horizonLabels[s.timeHorizon]}</td></tr>
  <tr><td style="font-weight:600">Severity</td><td>${severityLabels[s.severity]}</td></tr>
  <tr><td style="font-weight:600">Affected Population</td><td>${(s.site.population + s.site.staffOnSite).toLocaleString()} (${s.site.population.toLocaleString()} local + ${s.site.staffOnSite.toLocaleString()} staff)</td></tr>
  <tr><td style="font-weight:600">Base Capacity</td><td>${s.periodCapacity} ${capacityLabel} (${config.organisation.staffCount} staff)</td></tr>
  <tr><td style="font-weight:600">Weighted Avg Days/Claim</td><td>${s.weightedDaysPerClaim.toFixed(1)} days</td></tr>
  <tr><td style="font-weight:600">Claim Complexity Mix</td><td>Auto: ${s.claimComplexity.autoProcessedPct}% | 2-day: ${s.claimComplexity.twoDayPct}% | ${s.claimComplexity.customDays}-day: ${s.claimComplexity.customDayPct}% | Standard (${s.claimComplexity.standardDays || 4}d): ${Math.max(0, 100 - s.claimComplexity.autoProcessedPct - s.claimComplexity.twoDayPct - s.claimComplexity.customDayPct)}%</td></tr>
  <tr><td style="font-weight:600">Target Processing Time</td><td>${targetLabel}</td></tr>
  ${surgeRows}
</table>

${(() => {
    const distTemplate = getClaimDistributionTemplate(s.incident);
    const reserveFactor = getReserveDevelopmentFactor(s.timeHorizon);
    const categories = getApplicableClaimCategories(s.incident);
    const patternDesc = PATTERN_DESCRIPTIONS[s.incident];

    let researchSection = '';

    // Pattern note with bimodal insight
    if (s.incident === 'chemical' || s.incident === 'nuclear') {
      researchSection += `
<div class="pattern-note">
  <strong>Claim Pattern Note (Bimodal Distribution):</strong> ${s.incident === 'chemical' ?
    'Chemical (toxic release) incidents show bimodal distribution: 25% of claims in weeks 1-4 (acute poisoning, immediate property), then 45% emerge over years 2-40 (chronic illness, cancers, environmental). Based on Bhopal (1M+ claims over 40 years), Seveso (1976). Discovery rule applies: 3-year limitation from when claimant gains knowledge.' :
    'Nuclear incidents show distinct claim development: Only 5-10% in first 6 months (evacuation, acute), 20-30% at 6mo-3yrs (property, BI), 30-40% at 3-10yrs (health monitoring), 20-40% at 10-30yrs (latent cancers). UK Nuclear Installations Act 2022: 30-year personal injury limitation, environmental reinstatement now covered.'}
</div>`;
    }

    // Claim distribution template
    if (distTemplate) {
      researchSection += `
<h2>Claim Distribution Pattern (Research-Based)</h2>
<p style="font-size:13px;color:#64748b;margin-bottom:12px"><strong>${distTemplate.name}</strong> - Bimodal distribution based on historical incident data</p>
<table>
  <thead><tr><th>Period</th><th>% of Claims</th><th>Claim Types</th></tr></thead>
  <tbody>
    ${distTemplate.distribution.map(d => `<tr><td style="font-weight:600">${d.period}</td><td style="font-weight:700">${d.percent}%</td><td>${d.types}</td></tr>`).join('')}
  </tbody>
</table>`;
    }

    // Claim categories and timelines
    researchSection += `
<h2>Claim Categories &amp; Timelines</h2>
<table>
  <thead><tr><th>Category</th><th>Description</th><th>Logging</th><th>Settlement</th></tr></thead>
  <tbody>
    ${categories.map(cat => {
      const logUnit = cat.loggingTimeline.unit === 'yearsAfterDiagnosis' ? 'years (after diagnosis)' : cat.loggingTimeline.unit;
      const settleUnit = cat.settlementTimeline.unit === 'yearsAfterDiagnosis' ? 'years (after diagnosis)' : cat.settlementTimeline.unit;
      return `<tr><td style="font-weight:600">${cat.name}</td><td style="color:#64748b">${cat.description}</td><td>${cat.loggingTimeline.min}-${cat.loggingTimeline.max} ${logUnit}</td><td>${cat.settlementTimeline.min}-${cat.settlementTimeline.max} ${settleUnit}</td></tr>`;
    }).join('')}
  </tbody>
</table>`;

    // Reserve development factors
    if (reserveFactor && reserveFactor.min) {
      researchSection += `
<div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;padding:12px;margin:16px 0">
  <strong>Reserve Development Factor (${s.timeHorizon} term):</strong> ${reserveFactor.min}x - ${reserveFactor.max}x of initial estimates. <em>${reserveFactor.note}</em>
</div>`;
    }

    // UK Nuclear Legal Framework
    if (s.incident === 'nuclear') {
      const nuc = UK_LEGAL_FRAMEWORK.nuclearLimitations;
      researchSection += `
<h2>UK Nuclear Legal Framework</h2>
<p style="font-size:13px;font-weight:700;color:#ef4444">UK Nuclear Installations Act 1965 (as amended 2022)</p>
<table>
  <thead><tr><th>Parameter</th><th>Pre-2022</th><th>Post-2022 (Current)</th></tr></thead>
  <tbody>
    <tr><td>Operator Liability Cap</td><td>${nuc.pre2022.operatorLiabilityCap}</td><td style="font-weight:700">${nuc.post2022.operatorLiabilityCap}</td></tr>
    <tr><td>Personal Injury Limitation</td><td>${nuc.pre2022.personalInjury.years} years</td><td style="font-weight:700;color:#22c55e">${nuc.post2022.personalInjury.years} years (extended)</td></tr>
    <tr><td>Property Damage Limitation</td><td>${nuc.pre2022.propertyDamage.years} years</td><td>${nuc.post2022.propertyDamage.years} years</td></tr>
    <tr><td>Environmental Reinstatement</td><td style="color:#ef4444">Not covered</td><td style="font-weight:700;color:#22c55e">Now covered</td></tr>
  </tbody>
</table>
<p style="font-size:12px;color:#64748b;margin-top:8px"><strong>Discovery Rule:</strong> ${UK_LEGAL_FRAMEWORK.discoveryRule.description}</p>`;
    }

    // Historical reference
    if (patternDesc && patternDesc.historicalRef) {
      researchSection += `
<div style="background:#e0f2fe;border:1px solid #0284c7;border-radius:8px;padding:12px;margin:16px 0;font-size:12px">
  <strong style="color:#0369a1">Historical Reference:</strong> ${patternDesc.historicalRef}
</div>`;
    }

    return researchSection;
  })()}

<h2>Key Metrics</h2>
<div class="metrics">
  <div class="metric"><div class="metric-val blue">${s.totalClaims.toLocaleString()}</div><div class="metric-lbl">Total Estimated Claims</div></div>
  ${claimBreakdownMetrics}
  <div class="metric"><div class="metric-val yellow">${periodLabel} ${s.peakPeriod}</div><div class="metric-lbl">Peak ${periodLabel} (${s.peakClaims} claims)</div></div>
  <div class="metric"><div class="metric-val ${s.canMeetTarget ? 'green' : 'red'}">${s.canMeetTarget ? 'Yes' : 'No'}</div><div class="metric-lbl">Cleared Within ${targetLabel}?</div></div>
  <div class="metric"><div class="metric-val ${s.canMeetTarget ? 'green' : 'red'}">${timeToClearLabel}</div><div class="metric-lbl">Time to Clear</div></div>
  <div class="metric"><div class="metric-val ${s.additionalStaff === 0 ? 'green' : 'red'}">+${s.additionalStaff}</div><div class="metric-lbl">Additional Staff Required</div></div>
  <div class="metric"><div class="metric-val yellow">${s.maxBacklog.toLocaleString()}</div><div class="metric-lbl">Peak Backlog</div></div>
</div>

<h2>${periodLabel}ly Breakdown</h2>
<table>
  <thead><tr>${tableHeaders}</tr></thead>
  <tbody>${periodRows}</tbody>
</table>

<h2>Resource Requirements</h2>
<table>
  <tr><td style="font-weight:600">Current Staff</td><td>${config.organisation.staffCount}</td></tr>
  <tr><td style="font-weight:600">Staff Needed at Peak</td><td>${s.staffNeededAtPeak}</td></tr>
  <tr><td style="font-weight:600">Additional Staff Required</td><td style="color:${s.additionalStaff > 0 ? '#ef4444' : '#22c55e'};font-weight:700">${s.additionalStaff > 0 ? '+' + s.additionalStaff : 'None'}</td></tr>
  <tr><td style="font-weight:600">Claims/Staff/Week</td><td>${s.claimsPerStaffPerWeek.toFixed(1)}</td></tr>
  <tr><td style="font-weight:600">Capacity Coverage at Peak</td><td>${Math.round((s.periodCapacity / s.peakClaims) * 100)}%</td></tr>
</table>

<h2>Recommendations</h2>
<ul>${recsHtml}</ul>

<div class="footer">
  <p><strong>Claims Resilience Testing Tool</strong> — Report generated automatically for planning purposes.</p>
  <p style="margin-top:8px">Analysis based on historical incident patterns and research data including:</p>
  <ul style="margin-top:4px;padding-left:20px;font-size:10px">
    <li>BP Texas City (2005): 4,000 claims, $2.1B settlements</li>
    <li>Buncefield UK (2005): 2,700 claims, £300M-1B</li>
    <li>Bhopal (1984): 1M+ claims over 40 years, $470M settlement</li>
    <li>Fukushima (2011): 164,000 evacuees, $70B+ compensation</li>
    <li>Three Mile Island (1979): $82M documented, 14-year cleanup</li>
    <li>West, Texas (2013): $230M losses vs $1M coverage</li>
    <li>NFPA Fire Statistics, Allianz Global Claims Review</li>
    <li>UK Nuclear Installations Act 1965 (as amended 2022)</li>
  </ul>
  <p style="margin-top:8px;font-size:10px;color:#94a3b8">Key insight: Claim development follows bimodal distribution — immediate spike of property/acute injury, followed by long tail of latent illness claims (30+ years for chemical/nuclear).</p>
</div>
</body></html>`;

  // Open in a new window and trigger print (Save as PDF)
  const printWindow = window.open('', '_blank');
  if (!printWindow) { alert('Please allow pop-ups to generate the PDF report.'); return; }
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.onload = function() { printWindow.print(); };
}

// ===== INIT =====
populateSites();
runScenario();

// Redraw on resize
window.addEventListener('resize', () => {
  if (document.getElementById('resultsArea').style.display !== 'none') {
    runScenario();
  }
});
</script>
</body>
</html>
